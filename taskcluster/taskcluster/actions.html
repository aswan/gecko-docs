

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Actions &mdash; Mozilla Source Tree Docs 59.0a1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Mozilla Source Tree Docs 59.0a1 documentation" href="../../index.html"/>
        <link rel="up" title="TaskCluster Task-Graph Generation" href="index.html"/>
        <link rel="next" title="How Tos" href="how-tos.html"/>
        <link rel="prev" title="Try" href="try.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Mozilla Source Tree Docs
          

          
          </a>

          
            
            
              <div class="version">
                59.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../browser/base/sslerrorreport/index.html">SSL Error Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../browser/browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../browser/experiments/experiments/index.html">Telemetry Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/fennec/index.html">Firefox for Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/fennec/index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mach/index.html">mach</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">TaskCluster Task-Graph Generation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="taskgraph.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="mach.html">Mach commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading.html">Loading Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="transforms.html">Transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimization.html">Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="docker-images.html">Docker Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="cron.html">Periodic Taskgraphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="try.html">Try</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Actions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#defining-action-tasks">Defining Action Tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-callback-action">Creating a Callback Action</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setting-the-action-context">Setting the Action Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#specifying-an-input-schema">Specifying an Input Schema</a></li>
<li class="toctree-l4"><a class="reference internal" href="#conditional-availability">Conditional Availability</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-custom-action-task">Creating a Custom Action Task</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="how-tos.html">How Tos</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference.html">Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/crashes/crash-manager/index.html">Crash Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/extensions/webextensions/index.html">WebExtensions API Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/payments/docs/index.html">WebPayments UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/telemetry/telemetry/index.html">Telemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/url-classifier/url-classifier/index.html">URL Classifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/crashreporter/crashreporter/index.html">Crash Reporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/modules/subprocess/toolkit_modules/subprocess/index.html">Supbrocess Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/modules/toolkit_modules/index.html">Toolkit modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/mozapps/extensions/addon-manager/index.html">Add-on Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/compare-locales/index.html">Localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/lint/index.html">Linting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/lint/index.html#indices-and-tables">Indices and tables</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../python/mach.html">mach package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozbuild.html">mozbuild package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozlint.html">mozlint package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozpack.html">mozpack package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozversioncontrol.html">mozversioncontrol package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozwebidlcodegen.html">mozwebidlcodegen package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/taskgraph.html">taskgraph package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Mozilla Source Tree Docs</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">TaskCluster Task-Graph Generation</a> &raquo;</li>
        
      <li>Actions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/taskcluster/taskcluster/actions.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="actions">
<h1>Actions<a class="headerlink" href="#actions" title="Permalink to this headline">¶</a></h1>
<p>This document shows how to define an action in-tree such that it shows up in
supported user interfaces like Treeherder. For details on interface between
in-tree logic and external user interfaces, see <a class="reference external" href="https://docs.taskcluster.net/manual/tasks/actions/spec">the actions.json spec</a>.</p>
<p>At a very high level, the process looks like this:</p>
<blockquote>
<div><ul class="simple">
<li>The decision task produces an artifact, <code class="docutils literal"><span class="pre">public/actions.json</span></code>, indicating
what actions are available.</li>
<li>A user interface (for example, Treeherder or the Taskcluster tools) consults
<code class="docutils literal"><span class="pre">actions.json</span></code> and presents appropriate choices to the user, if necessary
gathering additional data from the user, such as the number of times to
re-trigger a test case.</li>
<li>The user interface follows the action description to carry out the action.
In most cases (<code class="docutils literal"><span class="pre">action.kind</span> <span class="pre">==</span> <span class="pre">'task'</span></code>), that entails creating an “action
task”, including the provided information. That action task is responsible
for carrying out the named action, and may create new sub-tasks if necessary
(for example, to re-trigger a task).</li>
</ul>
</div></blockquote>
<div class="section" id="defining-action-tasks">
<h2>Defining Action Tasks<a class="headerlink" href="#defining-action-tasks" title="Permalink to this headline">¶</a></h2>
<p>There are two options for defining actions: creating a callback action, or
creating a custom action task.  A callback action automatically defines an
action task that will invoke a Python function of your devising.</p>
<p>A custom action task is an arbitrary task definition that will be created
directly.  In cases where the callback would simply call <code class="docutils literal"><span class="pre">queue.createTask</span></code>,
a custom action task can be more efficient.</p>
</div>
<div class="section" id="creating-a-callback-action">
<h2>Creating a Callback Action<a class="headerlink" href="#creating-a-callback-action" title="Permalink to this headline">¶</a></h2>
<p>A <em>callback action</em> is an action that calls back into in-tree logic. That is,
you register the action with name, title, description, context, input schema and a
python callback. When the action is triggered in a user interface,
input matching the schema is collected, passed to a new task which then calls
your python callback, enabling it to do pretty much anything it wants to.</p>
<p>To create a new callback action you must create a file
<code class="docutils literal"><span class="pre">taskcluster/taskgraph/actions/my-action.py</span></code>, that at minimum contains:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">registry</span> <span class="k">import</span> <span class="n">register_callback_action</span>

<span class="nd">@register_callback_action</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Say Hello&#39;</span><span class="p">,</span>
    <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;hw&#39;</span><span class="p">,</span>  <span class="c1"># Show the callback task in treeherder as &#39;hw&#39;</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Simple **proof-of-concept** callback action&quot;</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>  <span class="c1"># Order in which it should appear relative to other actions</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world_action</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">task_group_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="c1"># parameters is an instance of taskgraph.parameters.Parameters</span>
    <span class="c1"># it carries decision task parameters from the original decision task.</span>
    <span class="c1"># input, task_id, and task should all be None</span>
    <span class="nb">print</span> <span class="s2">&quot;Hello was triggered from taskGroupId: &quot;</span> <span class="o">+</span> <span class="n">taskGroupId</span>
</pre></div>
</div>
<p>Callback actions are configured in-tree to generate 3 artifacts when they run.
These artifacts are similar to the artifacts generated by decision tasks since
callback actions are basically mini decision tasks. The artifacts are:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">task-graph.json</span></code>:</dt>
<dd>The graph of all tasks created by the action task. Includes tasks
created to satisfy requirements.</dd>
<dt><code class="docutils literal"><span class="pre">to-run.json</span></code>:</dt>
<dd>The set of tasks that the action task requested to build. This does not
include the requirements.</dd>
<dt><code class="docutils literal"><span class="pre">label-to-taskid.json</span></code>:</dt>
<dd>This is the mapping from label to <code class="docutils literal"><span class="pre">taskid</span></code> for all tasks involved in
the task-graph. This includes dependencies.</dd>
</dl>
<p>The example above defines an action that is available in the context-menu for
the entire task-group (result-set or push in Treeherder terminology). To create
an action that shows up in the context menu for a task we would specify the
<code class="docutils literal"><span class="pre">context</span></code> parameter.</p>
<div class="section" id="setting-the-action-context">
<h3>Setting the Action Context<a class="headerlink" href="#setting-the-action-context" title="Permalink to this headline">¶</a></h3>
<p>The context parameter should be a list of tag-sets, such as
<code class="docutils literal"><span class="pre">context=[{&quot;platform&quot;:</span> <span class="pre">&quot;linux&quot;}]</span></code>, which will make the task show up in the
context-menu for any task with <code class="docutils literal"><span class="pre">task.tags.platform</span> <span class="pre">=</span> <span class="pre">'linux'</span></code>. Below is
some examples of context parameters and the resulting conditions on
<code class="docutils literal"><span class="pre">task.tags</span></code> (tags used below are just illustrative).</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">context=[{&quot;platform&quot;:</span> <span class="pre">&quot;linux&quot;}]</span></code>:</dt>
<dd>Requires <code class="docutils literal"><span class="pre">task.tags.platform</span> <span class="pre">=</span> <span class="pre">'linux'</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">context=[{&quot;kind&quot;:</span> <span class="pre">&quot;test&quot;,</span> <span class="pre">&quot;platform&quot;:</span> <span class="pre">&quot;linux&quot;}]</span></code>:</dt>
<dd>Requires <code class="docutils literal"><span class="pre">task.tags.platform</span> <span class="pre">=</span> <span class="pre">'linux'</span></code> <strong>and</strong> <code class="docutils literal"><span class="pre">task.tags.kind</span> <span class="pre">=</span> <span class="pre">'test'</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">context=[{&quot;kind&quot;:</span> <span class="pre">&quot;test&quot;},</span> <span class="pre">{&quot;platform&quot;:</span> <span class="pre">&quot;linux&quot;}]</span></code>:</dt>
<dd>Requires <code class="docutils literal"><span class="pre">task.tags.platform</span> <span class="pre">=</span> <span class="pre">'linux'</span></code> <strong>or</strong> <code class="docutils literal"><span class="pre">task.tags.kind</span> <span class="pre">=</span> <span class="pre">'test'</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">context=[{}]</span></code>:</dt>
<dd>Requires nothing and the action will show up in the context menu for all tasks.</dd>
<dt><code class="docutils literal"><span class="pre">context=[]</span></code>:</dt>
<dd>Is the same as not setting the context parameter, which will make the action
show up in the context menu for the task-group.
(i.e., the action is not specific to some task)</dd>
</dl>
<p>The example action below will be shown in the context-menu for tasks with
<code class="docutils literal"><span class="pre">task.tags.platform</span> <span class="pre">=</span> <span class="pre">'linux'</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">registry</span> <span class="k">import</span> <span class="n">register_callback_action</span>

<span class="nd">@register_callback_action</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;retrigger&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Retrigger&#39;</span><span class="p">,</span>
    <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;re-c&#39;</span><span class="p">,</span>  <span class="c1"># Show the callback task in treeherder as &#39;re-c&#39;</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Create a clone of the task&quot;</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;platform&#39;</span><span class="p">:</span> <span class="s1">&#39;linux&#39;</span><span class="p">}]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">retrigger_action</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">task_group_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="c1"># input will be None</span>
    <span class="nb">print</span> <span class="s2">&quot;Retriggering: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;task definition: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</pre></div>
</div>
<p>When the <code class="docutils literal"><span class="pre">context</span></code> parameter is set, the <code class="docutils literal"><span class="pre">task_id</span></code> and <code class="docutils literal"><span class="pre">task</span></code> parameters
will provided to the callback. In this case the <code class="docutils literal"><span class="pre">task_id</span></code> and <code class="docutils literal"><span class="pre">task</span></code>
parameters will be the <code class="docutils literal"><span class="pre">taskId</span></code> and <em>task definition</em> of the task from whose
context-menu the action was triggered.</p>
<p>Typically, the <code class="docutils literal"><span class="pre">context</span></code> parameter is used for actions that operate on
tasks, such as retriggering, running a specific test case, creating a loaner,
bisection, etc. You can think of the context as a place the action should
appear, but it’s also very much a form of input the action can use.</p>
</div>
<div class="section" id="specifying-an-input-schema">
<h3>Specifying an Input Schema<a class="headerlink" href="#specifying-an-input-schema" title="Permalink to this headline">¶</a></h3>
<p>In call examples so far the <code class="docutils literal"><span class="pre">input</span></code> parameter for the callbacks has been
<code class="docutils literal"><span class="pre">None</span></code>. To make an action that takes input you must specify an input schema.
This is done by passing a JSON schema as the <code class="docutils literal"><span class="pre">schema</span></code> parameter.</p>
<p>When designing a schema for the input it is important to exploit as many of the
JSON schema validation features as reasonably possible. Furthermore, it is
<em>strongly</em> encouraged that the <code class="docutils literal"><span class="pre">title</span></code> and <code class="docutils literal"><span class="pre">description</span></code> properties in
JSON schemas is used to provide a detailed explanation of what the input
value will do. Authors can reasonably expect JSON schema <code class="docutils literal"><span class="pre">description</span></code>
properties to be rendered as markdown before being presented.</p>
<p>The example below illustrates how to specify an input schema. Notice that while
this example doesn’t specify a <code class="docutils literal"><span class="pre">context</span></code> it is perfectly legal to specify
both <code class="docutils literal"><span class="pre">input</span></code> and <code class="docutils literal"><span class="pre">context</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">registry</span> <span class="k">import</span> <span class="n">register_callback_action</span>

<span class="nd">@register_callback_action</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;run-all&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Run All Tasks&#39;</span><span class="p">,</span>
    <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;ra-c&#39;</span><span class="p">,</span>  <span class="c1"># Show the callback task in treeherder as &#39;ra-c&#39;</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;**Run all tasks** that have been _optimized_ away.&quot;</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="nb">input</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Action Options&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Options for how you wish to run all tasks&#39;</span><span class="p">,</span>
        <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;priority&#39;</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Priority that should be given to the tasks&#39;</span><span class="p">,</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
                <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">],</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;runTalos&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Run Talos&#39;</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Do you wish to also include talos tasks?&#39;</span><span class="p">,</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="s1">&#39;runTalos&#39;</span><span class="p">],</span>
        <span class="s1">&#39;additionalProperties&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">retrigger_action</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">task_group_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Create all pruned tasks with priority: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;runTalos&#39;</span><span class="p">]:</span>
        <span class="nb">print</span> <span class="s2">&quot;Also running talos jobs...&quot;</span>
</pre></div>
</div>
<p>When the <code class="docutils literal"><span class="pre">schema</span></code> parameter is given the callback will always be called with
an <code class="docutils literal"><span class="pre">input</span></code> parameter that satisfies the previously given JSON schema.
It is encouraged to set <code class="docutils literal"><span class="pre">additionalProperties:</span> <span class="pre">false</span></code>, as well as specifying
all properties as <code class="docutils literal"><span class="pre">required</span></code> in the JSON schema. Furthermore, it’s good
practice to provide <code class="docutils literal"><span class="pre">default</span></code> values for properties, as user interface generators
will often take advantage of such properties.</p>
<p>Once you have specified input and context as applicable for your action you can
do pretty much anything you want from within your callback. Whether you want
to create one or more tasks or run a specific piece of code like a test.</p>
</div>
<div class="section" id="conditional-availability">
<h3>Conditional Availability<a class="headerlink" href="#conditional-availability" title="Permalink to this headline">¶</a></h3>
<p>The decision parameters <code class="docutils literal"><span class="pre">taskgraph.parameters.Parameters</span></code> passed to
the callback are also available when the decision task generates the list of
actions to be displayed in the user interface. When registering an action
callback the <code class="docutils literal"><span class="pre">availability</span></code> option can be used to specify a callable
which, given the decision parameters, determines if the action should be available.
The feature is illustrated below:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">registry</span> <span class="k">import</span> <span class="n">register_callback_action</span>

<span class="nd">@register_callback_action</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Say Hello&#39;</span><span class="p">,</span>
    <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;hw&#39;</span><span class="p">,</span>  <span class="c1"># Show the callback task in treeherder as &#39;hw&#39;</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Simple **proof-of-concept** callback action&quot;</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="c1"># Define an action that is only included if this is a push to try</span>
    <span class="n">available</span><span class="o">=</span><span class="k">lambda</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;try&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">try_only_action</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">task_group_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;My try-only action&quot;</span>
</pre></div>
</div>
<p>Properties of <code class="docutils literal"><span class="pre">parameters</span></code>  are documented in the
<a class="reference internal" href="parameters.html"><span class="doc">parameters section</span></a>. You can also examine the
<code class="docutils literal"><span class="pre">parameters.yml</span></code> artifact created by decisions tasks.</p>
</div>
</div>
<div class="section" id="creating-a-custom-action-task">
<h2>Creating a Custom Action Task<a class="headerlink" href="#creating-a-custom-action-task" title="Permalink to this headline">¶</a></h2>
<p>It is possible to define an action that doesn’t take a callback. Instead, you’ll
then have to provide a task template. For details on how the task template
language works refer to <a class="reference external" href="https://docs.taskcluster.net/manual/tasks/actions/spec">the actions.json spec</a>. There are two options for
creating this sort of action in-tree. The first option is to create a yaml file
and the second allows you to use Python to do some extra work if you’d like.
The example below illustrates how to create such an action in Python:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">registry</span> <span class="k">import</span> <span class="n">register_task_action</span>

<span class="nd">@register_task_action</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;retrigger&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Retrigger&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Create a clone of the task&quot;</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;platform&#39;</span><span class="p">:</span> <span class="s1">&#39;linux&#39;</span><span class="p">}],</span>
    <span class="nb">input</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;priority&#39;</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Priority that should be given to the tasks&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
        <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">],</span>
        <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">task_template_builder</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
    <span class="c1"># The task template builder may return None to signal that the action</span>
    <span class="c1"># isn&#39;t available.</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;try&#39;</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$fromNow&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
        <span class="s1">&#39;deadline&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$fromNow&#39;</span><span class="p">:</span> <span class="s1">&#39;1 hour&#39;</span><span class="p">},</span>
        <span class="s1">&#39;expires&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$fromNow&#39;</span><span class="p">:</span> <span class="s1">&#39;14 days&#39;</span><span class="p">},</span>
        <span class="s1">&#39;provisionerId&#39;</span><span class="p">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span>
        <span class="s1">&#39;workerType&#39;</span><span class="p">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span>
        <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;$</span><span class="si">{input}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span>
            <span class="s1">&#39;env&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;TASK_DEFINITION&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$json&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;eval&#39;</span><span class="p">:</span> <span class="s1">&#39;task&#39;</span><span class="p">}}</span>
            <span class="p">},</span>
            <span class="o">...</span>
        <span class="p">},</span>
        <span class="c1"># It&#39;s now your responsibility to include treeherder routes, as well</span>
        <span class="c1"># additional metadata for treeherder in task.extra.treeherder.</span>
        <span class="o">...</span>
    <span class="p">},</span>
</pre></div>
</div>
<p>An equivalent in yaml. Notice that we can’t inspect parameters in this case:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="n">name</span><span class="p">:</span> <span class="n">retrigger</span>
<span class="n">title</span><span class="p">:</span> <span class="n">Retrigger</span>
<span class="n">description</span><span class="p">:</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">clone</span> <span class="n">of</span> <span class="n">the</span> <span class="n">task</span>
<span class="n">order</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">context</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">platform</span><span class="p">:</span> <span class="n">linux</span>
<span class="nb">input</span><span class="p">:</span>
  <span class="n">title</span><span class="p">:</span> <span class="n">priority</span>
  <span class="n">description</span><span class="p">:</span> <span class="n">Priority</span> <span class="n">that</span> <span class="n">should</span> <span class="n">be</span> <span class="n">given</span> <span class="n">to</span> <span class="n">the</span> <span class="n">tasks</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">string</span>
  <span class="n">enum</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">low</span>
    <span class="o">-</span> <span class="n">normal</span>
    <span class="o">-</span> <span class="n">high</span>
  <span class="n">default</span><span class="p">:</span> <span class="n">low</span><span class="s1">&#39;</span>
<span class="o">---</span>
<span class="n">created</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$fromNow&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
<span class="n">deadline</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$fromNow&#39;</span><span class="p">:</span> <span class="s1">&#39;1 hour&#39;</span><span class="p">}</span>
<span class="n">expires</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$fromNow&#39;</span><span class="p">:</span> <span class="s1">&#39;14 days&#39;</span><span class="p">}</span>
<span class="n">provisionerId</span><span class="p">:</span> <span class="s1">&#39;...&#39;</span>
<span class="n">workerType</span><span class="p">:</span> <span class="s1">&#39;...&#39;</span>
<span class="n">priority</span><span class="p">:</span> <span class="s1">&#39;$</span><span class="si">{input}</span><span class="s1">&#39;</span>
<span class="n">payload</span><span class="p">:</span>
  <span class="n">command</span><span class="p">:</span> <span class="s1">&#39;...&#39;</span>
  <span class="n">env</span><span class="p">:</span>
    <span class="n">TASK_DEFINITION</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$json&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;eval&#39;</span><span class="p">:</span> <span class="s1">&#39;task&#39;</span><span class="p">}}</span>
</pre></div>
</div>
<p>These kinds of actions are useful for creating simple derivative tasks, but are
limited by the expressiveness of the template language. On the other hand, they
are more efficient than an action callback as they do not involve an
intermediate action task before creating the task the user requested.</p>
<p>For further details on the template language, see <a class="reference external" href="https://docs.taskcluster.net/manual/tasks/actions/spec">the actions.json spec</a>.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="how-tos.html" class="btn btn-neutral float-right" title="How Tos" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="try.html" class="btn btn-neutral" title="Try" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright .

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'59.0a1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>