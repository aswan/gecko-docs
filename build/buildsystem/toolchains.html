

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating Toolchain Archives &mdash; Mozilla Source Tree Docs 59.0a1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Mozilla Source Tree Docs 59.0a1 documentation" href="../../index.html"/>
        <link rel="up" title="Build System" href="index.html"/>
        <link rel="next" title="Localization (l10n)" href="locales.html"/>
        <link rel="prev" title="Defining Binaries for the Build System" href="defining-binaries.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Mozilla Source Tree Docs
          

          
          </a>

          
            
            
              <div class="version">
                59.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../browser/base/sslerrorreport/index.html">SSL Error Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../browser/browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../browser/experiments/experiments/index.html">Telemetry Experiments</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Build System</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#important-concepts">Important Concepts</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="build-overview.html">Build System Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="supported-configurations.html">Supported Configurations</a></li>
<li class="toctree-l3"><a class="reference internal" href="mozconfigs.html">Mozconfig Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="mozbuild-files.html">moz.build Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="mozbuild-symbols.html">mozbuild Sandbox Symbols</a></li>
<li class="toctree-l3"><a class="reference internal" href="files-metadata.html">Files Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="pgo.html">Profile Guided Optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="slow.html">Why the Build System is Slow</a></li>
<li class="toctree-l3"><a class="reference internal" href="environment-variables.html">Environment Variables Impacting the Build System</a></li>
<li class="toctree-l3"><a class="reference internal" href="build-targets.html">Build Targets</a></li>
<li class="toctree-l3"><a class="reference internal" href="python.html">Python and the Build System</a></li>
<li class="toctree-l3"><a class="reference internal" href="test_manifests.html">Test Manifests</a></li>
<li class="toctree-l3"><a class="reference internal" href="mozinfo.html">mozinfo</a></li>
<li class="toctree-l3"><a class="reference internal" href="preprocessor.html">Text Preprocessor</a></li>
<li class="toctree-l3"><a class="reference internal" href="jar-manifests.html">JAR Manifests</a></li>
<li class="toctree-l3"><a class="reference internal" href="defining-binaries.html">Defining Binaries for the Build System</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Creating Toolchain Archives</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#clang">Clang</a></li>
<li class="toctree-l4"><a class="reference internal" href="#windows">Windows</a></li>
<li class="toctree-l4"><a class="reference internal" href="#firefox-for-android-with-gradle">Firefox for Android with Gradle</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="locales.html">Localization (l10n)</a></li>
<li class="toctree-l3"><a class="reference internal" href="rust.html">Including Rust Code in Firefox</a></li>
<li class="toctree-l3"><a class="reference internal" href="sparse.html">Sparse Checkouts</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#integrated-development-environment-ide">integrated development environment (IDE)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#mozbuild">mozbuild</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/fennec/index.html">Firefox for Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/fennec/index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mach/index.html">mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/crashes/crash-manager/index.html">Crash Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/extensions/webextensions/index.html">WebExtensions API Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/payments/docs/index.html">WebPayments UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/telemetry/telemetry/index.html">Telemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/url-classifier/url-classifier/index.html">URL Classifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/crashreporter/crashreporter/index.html">Crash Reporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/modules/subprocess/toolkit_modules/subprocess/index.html">Supbrocess Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/modules/toolkit_modules/index.html">Toolkit modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/mozapps/extensions/addon-manager/index.html">Add-on Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/compare-locales/index.html">Localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/lint/index.html">Linting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/lint/index.html#indices-and-tables">Indices and tables</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../python/mach.html">mach package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozbuild.html">mozbuild package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozlint.html">mozlint package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozpack.html">mozpack package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozversioncontrol.html">mozversioncontrol package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozwebidlcodegen.html">mozwebidlcodegen package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/taskgraph.html">taskgraph package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Mozilla Source Tree Docs</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Build System</a> &raquo;</li>
        
      <li>Creating Toolchain Archives</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/build/buildsystem/toolchains.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="creating-toolchain-archives">
<span id="build-toolchains"></span><h1>Creating Toolchain Archives<a class="headerlink" href="#creating-toolchain-archives" title="Permalink to this headline">¶</a></h1>
<p>There are various scripts in the repository for producing archives
of the build tools (e.g. compilers and linkers) required to build.</p>
<div class="section" id="clang">
<h2>Clang<a class="headerlink" href="#clang" title="Permalink to this headline">¶</a></h2>
<p>See the <code class="docutils literal"><span class="pre">build/build-clang</span></code> directory. Read <code class="docutils literal"><span class="pre">build/build-clang/README</span></code>
for more.</p>
</div>
<div class="section" id="windows">
<h2>Windows<a class="headerlink" href="#windows" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">build/windows_toolchain.py</span></code> script is used to build and manage
Windows toolchain archives containing Visual Studio executables, SDKs,
etc.</p>
<p>The way Firefox build automation works is an archive containing the
toolchain is produced and uploaded to an internal Mozilla server. The
build automation will download, verify, and extract this archive before
building. The archive is self-contained so machines don’t need to install
Visual Studio, SDKs, or various other dependencies. Unfortunately,
Microsoft’s terms don’t allow Mozilla to distribute this archive
publicly. However, the same tool can be used to create your own copy.</p>
<div class="section" id="configuring-your-system">
<h3>Configuring Your System<a class="headerlink" href="#configuring-your-system" title="Permalink to this headline">¶</a></h3>
<p>It is <strong>highly</strong> recommended to perform this process on a fresh installation
of Windows 7 or 10 (such as in a VM). Installing all updates through
Windows Update is not only acceptable - it is encouraged. Although it
shouldn’t matter.</p>
<p>Next, install Visual Studio 2015 Community. The download link can be
found at <a class="reference external" href="https://www.visualstudio.com/en-us/products/visual-studio-community-vs.aspx">https://www.visualstudio.com/en-us/products/visual-studio-community-vs.aspx</a>.
Be sure to follow these install instructions:</p>
<ol class="arabic simple">
<li>Choose a <code class="docutils literal"><span class="pre">Custom</span></code> installation and click <code class="docutils literal"><span class="pre">Next</span></code></li>
<li>Select <code class="docutils literal"><span class="pre">Programming</span> <span class="pre">Languages</span></code> -&gt; <code class="docutils literal"><span class="pre">Visual</span> <span class="pre">C++</span></code> (make sure all sub items are
selected)</li>
<li>Under <code class="docutils literal"><span class="pre">Windows</span> <span class="pre">and</span> <span class="pre">Web</span> <span class="pre">Development</span></code> uncheck everything except
<code class="docutils literal"><span class="pre">Universal</span> <span class="pre">Windows</span> <span class="pre">App</span> <span class="pre">Development</span> <span class="pre">Tools</span></code> and the items under it
(should be <code class="docutils literal"><span class="pre">Tools</span> <span class="pre">(1.3.1)...</span></code> and the <code class="docutils literal"><span class="pre">Windows</span> <span class="pre">10</span> <span class="pre">SDK</span></code>).</li>
</ol>
<p>Once Visual Studio 2015 Community has been installed, from a checkout
of mozilla-central, run something like the following to produce a ZIP
archive:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ ./mach python build/windows_toolchain.py create-zip vs2017_15.4.2
</pre></div>
</div>
<p>The produced archive will be the argument to <code class="docutils literal"><span class="pre">create-zip</span></code> + <code class="docutils literal"><span class="pre">.zip</span></code>.</p>
</div>
</div>
<div class="section" id="firefox-for-android-with-gradle">
<h2>Firefox for Android with Gradle<a class="headerlink" href="#firefox-for-android-with-gradle" title="Permalink to this headline">¶</a></h2>
<p>To build Firefox for Android with Gradle in automation, archives
containing both the Gradle executable and a Maven repository
comprising the exact build dependencies are produced and uploaded to
an internal Mozilla server.  The build automation will download,
verify, and extract these archive before building.  These archives
provide a self-contained Gradle and Maven repository so that machines
don’t need to fetch additional Maven dependencies at build time.
(Gradle and the downloaded Maven dependencies can be both
redistributed publicly.)</p>
<p>Archiving the Gradle executable is straight-forward, but archiving a
local Maven repository is not.  Therefore a special Task Cluster
Docker image and job exist for producing the required archives.  The
Docker image definition is rooted in
<code class="docutils literal"><span class="pre">taskcluster/docker/android-build</span></code>.  The Task Cluster job
definition is in
<code class="docutils literal"><span class="pre">testing/taskcluster/tasks/builds/android_api_16_gradle_dependencies.yml</span></code>.
The job runs in a container based on the custom Docker image and
spawns a Sonatype Nexus proxying Maven repository process in the
background.  The job builds Firefox for Android using Gradle and the
in-tree Gradle configuration rooted at <code class="docutils literal"><span class="pre">build.gradle</span></code>.  The spawned
proxying Maven repository downloads external dependencies and collects
them.  After the Gradle build completes, the job archives the Gradle
version used to build, and the downloaded Maven repository, and
exposes them as Task Cluster artifacts.</p>
<p>Here is <a class="reference external" href="https://treeherder.mozilla.org/#/jobs?repo=try&amp;revision=75bc98935147&amp;selectedJob=17793653">an example try job fetching these dependencies</a>.
The resulting task produced a <a class="reference external" href="https://queue.taskcluster.net/v1/task/CeYMgAP3Q-KF8h37nMhJjg/runs/0/artifacts/public%2Fbuild%2Fgradle.tar.xz">Gradle archive</a>
and a <a class="reference external" href="https://queue.taskcluster.net/v1/task/CeYMgAP3Q-KF8h37nMhJjg/runs/0/artifacts/public%2Fbuild%2Fjcentral.tar.xz">Maven repository archive</a>.
These archives were then uploaded (manually) to Mozilla automation
using tooltool for consumption in Gradle builds.</p>
<p>To update the version of Gradle in the archive produced, update
<code class="docutils literal"><span class="pre">gradle/wrapper/gradle-wrapper.properties</span></code>.  Be sure to also update
the SHA256 checksum to prevent poisoning the build machines!</p>
<p>To update the versions of Gradle dependencies used, update
<code class="docutils literal"><span class="pre">dependencies</span></code> sections in the in-tree Gradle configuration rooted
at <code class="docutils literal"><span class="pre">build.gradle</span></code>.  Once you are confident your changes build
locally, push a fresh try build with an invocation like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ hg push-to-try -m &quot;try: -b o -p android-api-16-gradle-dependencies&quot;
</pre></div>
</div>
<p>Then <a class="reference external" href="https://wiki.mozilla.org/ReleaseEngineering/Applications/Tooltool#How_To_Upload_To_Tooltool">upload your archives to tooltool</a>,
update the in-tree manifests in
<code class="docutils literal"><span class="pre">mobile/android/config/tooltool-manifests</span></code>, and push a fresh try
build.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="locales.html" class="btn btn-neutral float-right" title="Localization (l10n)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="defining-binaries.html" class="btn btn-neutral" title="Defining Binaries for the Build System" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright .

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'59.0a1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>