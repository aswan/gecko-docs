

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mozlog — Structured logging for test output &mdash; Mozilla Source Tree Docs 59.0a1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Mozilla Source Tree Docs 59.0a1 documentation" href="../index.html"/>
        <link rel="up" title="Logging and reporting" href="loggingreporting.html"/>
        <link rel="next" title="mach" href="../python/mach/index.html"/>
        <link rel="prev" title="Logging and reporting" href="loggingreporting.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Mozilla Source Tree Docs
          

          
          </a>

          
            
            
              <div class="version">
                59.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../browser/base/sslerrorreport/index.html">SSL Error Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../browser/browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../browser/experiments/experiments/index.html">Telemetry Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gfx/gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/android/fennec/index.html">Firefox for Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/android/fennec/index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">mozbase</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="manifestparser.html">Managing lists of tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="gettinginfo.html">Getting information on the system under test</a></li>
<li class="toctree-l2"><a class="reference internal" href="setuprunning.html">Set up and running</a></li>
<li class="toctree-l2"><a class="reference internal" href="mozhttpd.html">Serving up content to be consumed by the browser</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="loggingreporting.html">Logging and reporting</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#"><code class="docutils literal"><span class="pre">mozlog</span></code> — Structured logging for test output</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#data-format">Data Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testsuite-protocol">Testsuite Protocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-mozlog.structuredlog">StructuredLogger Objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#proxylogger-objects">ProxyLogger Objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#handlers">Handlers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#formatters">Formatters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#processing-log-files">Processing Log Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#integration-with-argparse">Integration with argparse</a></li>
<li class="toctree-l4"><a class="reference internal" href="#simple-examples">Simple Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="#more-complete-example">More Complete Example</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/mach/index.html">mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../taskcluster/taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/geckodriver/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/marionette/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/components/crashes/crash-manager/index.html">Crash Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/components/extensions/webextensions/index.html">WebExtensions API Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/components/payments/docs/index.html">WebPayments UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/components/telemetry/telemetry/index.html">Telemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/components/url-classifier/url-classifier/index.html">URL Classifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/crashreporter/crashreporter/index.html">Crash Reporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/modules/subprocess/toolkit_modules/subprocess/index.html">Supbrocess Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/modules/toolkit_modules/index.html">Toolkit modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/mozapps/extensions/addon-manager/index.html">Add-on Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/compare-locales/index.html">Localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/lint/index.html">Linting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/lint/index.html#indices-and-tables">Indices and tables</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python/mach.html">mach package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/mozbuild.html">mozbuild package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/mozlint.html">mozlint package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/mozpack.html">mozpack package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/mozversioncontrol.html">mozversioncontrol package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/mozwebidlcodegen.html">mozwebidlcodegen package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/taskgraph.html">taskgraph package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Mozilla Source Tree Docs</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">mozbase</a> &raquo;</li>
        
          <li><a href="loggingreporting.html">Logging and reporting</a> &raquo;</li>
        
      <li><code class="docutils literal"><span class="pre">mozlog</span></code> — Structured logging for test output</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/mozbase/mozlog.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mozlog-structured-logging-for-test-output">
<h1><code class="xref py py-mod docutils literal"><span class="pre">mozlog</span></code> — Structured logging for test output<a class="headerlink" href="#mozlog-structured-logging-for-test-output" title="Permalink to this headline">¶</a></h1>
<p><code class="xref py py-mod docutils literal"><span class="pre">mozlog</span></code> is a library designed for logging the
execution and results of test harnesses. The internal data model is a
stream of JSON-compatible objects, with one object per log entry. The
default output format is line-based, with one JSON object serialized
per line.</p>
<p><code class="xref py py-mod docutils literal"><span class="pre">mozlog</span></code> is <em>not</em> based on the stdlib logging
module, although it shares several concepts with it.</p>
<p>One notable difference between this module and the standard logging
module is the way that loggers are created. The structured logging
module does not require that loggers with a specific name are
singleton objects accessed through a factory function. Instead the
<code class="docutils literal"><span class="pre">StructuredLogger</span></code> constructor may be used directly. However all
loggers with the same name share the same internal state (the “Borg”
pattern). In particular the list of handler functions is the same for
all loggers with the same name.</p>
<p>Typically, you would only instantiate one logger object per
program. Two convenience methods are provided to set and get the
default logger in the program.</p>
<p>Logging is threadsafe, with access to handlers protected by a
<code class="docutils literal"><span class="pre">threading.Lock</span></code>. However it is <cite>not</cite> process-safe. This means that
applications using multiple processes, e.g. via the
<code class="docutils literal"><span class="pre">multiprocessing</span></code> module, should arrange for all logging to happen in
a single process.</p>
<div class="section" id="data-format">
<h2>Data Format<a class="headerlink" href="#data-format" title="Permalink to this headline">¶</a></h2>
<p>Structured loggers produce messages in a simple format designed to be
compatible with the JSON data model. Each message is a single object,
with the type of message indicated by the <code class="docutils literal"><span class="pre">action</span></code> key. It is
intended that the set of <code class="docutils literal"><span class="pre">action</span></code> values be closed; where there are
use cases for additional values they should be integrated into this
module rather than extended in an ad-hoc way. The set of keys present
on on all messages is:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">action</span></code></dt>
<dd>The type of the message (string).</dd>
<dt><code class="docutils literal"><span class="pre">time</span></code></dt>
<dd>The timestamp of the message in ms since the epoch (int).</dd>
<dt><code class="docutils literal"><span class="pre">thread</span></code></dt>
<dd>The name of the thread emitting the message (string).</dd>
<dt><code class="docutils literal"><span class="pre">pid</span></code></dt>
<dd>The pid of the process creating the message (int).</dd>
<dt><code class="docutils literal"><span class="pre">source</span></code></dt>
<dd>Name of the logger creating the message (string).</dd>
</dl>
<p>For each <code class="docutils literal"><span class="pre">action</span></code> there are is a further set of specific fields
describing the details of the event that caused the message to be
emitted:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">suite_start</span></code></dt>
<dd><p class="first">Emitted when the testsuite starts running.</p>
<dl class="last docutils">
<dt><code class="docutils literal"><span class="pre">tests</span></code></dt>
<dd>A dict of test ids keyed by group. Groups are any logical grouping
of tests, for example a manifest, directory or tag. For convenience,
a list of test ids can be used instead. In this case all tests will
automatically be placed in the ‘default’ group name. Test ids can
either be strings or lists of strings (an example of the latter is
reftests where the id has the form [test_url, ref_type, ref_url]).
Test ids are assumed to be unique within a given testsuite. In cases
where the test list is not known upfront an empty dict or list may
be passed (dict).</dd>
<dt><code class="docutils literal"><span class="pre">run_info</span></code></dt>
<dd>An optional dictionary describing the properties of the
build and test environment. This contains the information provided
by <a class="reference internal" href="mozinfo.html"><span class="doc">mozinfo</span></a>, plus a boolean <code class="docutils literal"><span class="pre">debug</span></code> field indicating
whether the build under test is a debug build.</dd>
</dl>
</dd>
<dt><code class="docutils literal"><span class="pre">suite_end</span></code></dt>
<dd>Emitted when the testsuite is finished and no more results will be produced.</dd>
<dt><code class="docutils literal"><span class="pre">test_start</span></code></dt>
<dd><p class="first">Emitted when a test is being started.</p>
<dl class="last docutils">
<dt><code class="docutils literal"><span class="pre">test</span></code></dt>
<dd>A unique id for the test (string or list of strings).</dd>
<dt><code class="docutils literal"><span class="pre">path</span></code></dt>
<dd>Optional path to the test relative to some base (typically the root of the
source tree). Mainly used when <code class="docutils literal"><span class="pre">test</span></code> id is not a path (string).</dd>
</dl>
</dd>
<dt><code class="docutils literal"><span class="pre">test_status</span></code></dt>
<dd><p class="first">Emitted for a test which has subtests to record the result of a
single subtest.</p>
<dl class="last docutils">
<dt><code class="docutils literal"><span class="pre">test</span></code></dt>
<dd>The same unique id for the test as in the <code class="docutils literal"><span class="pre">test_start</span></code> message.</dd>
<dt><code class="docutils literal"><span class="pre">subtest</span></code></dt>
<dd>Name of the subtest (string).</dd>
<dt><code class="docutils literal"><span class="pre">status</span></code></dt>
<dd>Result of the test (string enum; <code class="docutils literal"><span class="pre">PASS</span></code>, <code class="docutils literal"><span class="pre">FAIL</span></code>, <code class="docutils literal"><span class="pre">TIMEOUT</span></code>,
<code class="docutils literal"><span class="pre">NOTRUN</span></code>)</dd>
<dt><code class="docutils literal"><span class="pre">expected</span></code></dt>
<dd>Expected result of the test. Omitted if the expected result is the
same as the actual result (string enum, same as <code class="docutils literal"><span class="pre">status</span></code>).</dd>
</dl>
</dd>
<dt><code class="docutils literal"><span class="pre">test_end</span></code></dt>
<dd><p class="first">Emitted to give the result of a test with no subtests, or the status
of the overall file when there are subtests.</p>
<dl class="last docutils">
<dt><code class="docutils literal"><span class="pre">test</span></code></dt>
<dd>The same unique id for the test as in the <code class="docutils literal"><span class="pre">test_start</span></code> message.</dd>
<dt><code class="docutils literal"><span class="pre">status</span></code></dt>
<dd>Either result of the test (if there are no subtests) in which case
(string enum <code class="docutils literal"><span class="pre">PASS</span></code>, <code class="docutils literal"><span class="pre">FAIL</span></code>, <code class="docutils literal"><span class="pre">TIMEOUT</span></code>, <code class="docutils literal"><span class="pre">CRASH</span></code>,
<code class="docutils literal"><span class="pre">ASSERT</span></code>, <code class="docutils literal"><span class="pre">SKIP</span></code>) or the status of the overall file where
there are subtests (string enum <code class="docutils literal"><span class="pre">OK</span></code>, <code class="docutils literal"><span class="pre">ERROR</span></code>, <code class="docutils literal"><span class="pre">TIMEOUT</span></code>,
<code class="docutils literal"><span class="pre">CRASH</span></code>, <code class="docutils literal"><span class="pre">ASSERT</span></code>, <code class="docutils literal"><span class="pre">SKIP</span></code>).</dd>
<dt><code class="docutils literal"><span class="pre">expected</span></code></dt>
<dd>The expected status, or omitted if the expected status matches the
actual status (string enum, same as <code class="docutils literal"><span class="pre">status</span></code>).</dd>
</dl>
</dd>
<dt><code class="docutils literal"><span class="pre">process_output</span></code></dt>
<dd><p class="first">Output from a managed subprocess.</p>
<p><code class="docutils literal"><span class="pre">process</span></code>
pid of the subprocess.</p>
<p><code class="docutils literal"><span class="pre">command</span></code>
Command used to launch the subprocess.</p>
<p class="last"><code class="docutils literal"><span class="pre">data</span></code>
Data output by the subprocess.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">log</span></code></dt>
<dd><p class="first">General human-readable logging message, used to debug the harnesses
themselves rather than to provide input to other tools.</p>
<dl class="last docutils">
<dt><code class="docutils literal"><span class="pre">level</span></code></dt>
<dd>Level of the log message (string enum <code class="docutils literal"><span class="pre">CRITICAL</span></code>, <code class="docutils literal"><span class="pre">ERROR</span></code>,
<code class="docutils literal"><span class="pre">WARNING</span></code>, <code class="docutils literal"><span class="pre">INFO</span></code>, <code class="docutils literal"><span class="pre">DEBUG</span></code>).</dd>
<dt><code class="docutils literal"><span class="pre">message</span></code></dt>
<dd>Text of the log message.</dd>
</dl>
</dd>
</dl>
</div>
<div class="section" id="testsuite-protocol">
<h2>Testsuite Protocol<a class="headerlink" href="#testsuite-protocol" title="Permalink to this headline">¶</a></h2>
<p>When used for testsuites, the following structured logging messages must be emitted:</p>
<blockquote>
<div><ul class="simple">
<li>One <code class="docutils literal"><span class="pre">suite_start</span></code> message before any <code class="docutils literal"><span class="pre">test_*</span></code> messages</li>
<li>One <code class="docutils literal"><span class="pre">test_start</span></code> message per test that is run</li>
<li>One <code class="docutils literal"><span class="pre">test_status</span></code> message per subtest that is run. This might be
zero if the test type doesn’t have the notion of subtests.</li>
<li>One <code class="docutils literal"><span class="pre">test_end</span></code> message per test that is run, after the
<code class="docutils literal"><span class="pre">test_start</span></code> and any <code class="docutils literal"><span class="pre">test_status</span></code> messages for that same test.</li>
<li>One <code class="docutils literal"><span class="pre">suite_end</span></code> message after all <code class="docutils literal"><span class="pre">test_*</span></code> messages have been
emitted.</li>
</ul>
</div></blockquote>
<p>The above mandatory events may be interspersed with <code class="docutils literal"><span class="pre">process_output</span></code>
and <code class="docutils literal"><span class="pre">log</span></code> events, as required.</p>
<div class="section" id="subtests">
<h3>Subtests<a class="headerlink" href="#subtests" title="Permalink to this headline">¶</a></h3>
<p>The purpose of subtests is to deal with situations where a single test
produces more than one result, and the exact details of the number of
results is not known ahead of time. For example consider a test
harness that loads JavaScript-based tests in a browser. Each url
loaded would be a single test, with corresponding <code class="docutils literal"><span class="pre">test_start</span></code> and
<code class="docutils literal"><span class="pre">test_end</span></code> messages. If there can be more than one JS-defined test
on a page, however, it it useful to track the results of those tests
seperately. Therefore each of those tests is a subtest, and one
<code class="docutils literal"><span class="pre">test_status</span></code> message must be generated for each subtest result.</p>
<p>Subtests must have a name that is unique within their parent test.</p>
<p>Whether or not a test has subtests changes the meaning of the
<code class="docutils literal"><span class="pre">status</span></code> property on the test itself. When the test does not have
any subtests, this property is the actual test result such as <code class="docutils literal"><span class="pre">PASS</span></code>
or <code class="docutils literal"><span class="pre">FAIL</span></code> . When a test does have subtests, the test itself does not
have a result as-such; it isn’t meaningful to describe it as having a
<code class="docutils literal"><span class="pre">PASS</span></code> result, especially if the subtests did not all pass. Instead
this property is used to hold information about whether the test ran
without error. If no errors were detected the test must be given the
status <code class="docutils literal"><span class="pre">OK</span></code>. Otherwise the test may get the status <code class="docutils literal"><span class="pre">ERROR</span></code> (for
e.g. uncaught JS exceptions), <code class="docutils literal"><span class="pre">TIMEOUT</span></code> (if no results were reported
in the allowed time) or <code class="docutils literal"><span class="pre">CRASH</span></code> (if the test caused the process
under test to crash).</p>
</div>
</div>
<div class="section" id="module-mozlog.structuredlog">
<span id="structuredlogger-objects"></span><h2>StructuredLogger Objects<a class="headerlink" href="#module-mozlog.structuredlog" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="mozlog.structuredlog.set_default_logger">
<code class="descclassname">mozlog.structuredlog.</code><code class="descname">set_default_logger</code><span class="sig-paren">(</span><em>default_logger</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.set_default_logger" title="Permalink to this definition">¶</a></dt>
<dd><p>Sets the default logger to logger.</p>
<p>It can then be retrieved with <a class="reference internal" href="#mozlog.structuredlog.get_default_logger" title="mozlog.structuredlog.get_default_logger"><code class="xref py py-func docutils literal"><span class="pre">get_default_logger()</span></code></a></p>
<p>Note that <a class="reference internal" href="#mozlog.commandline.setup_logging" title="mozlog.commandline.setup_logging"><code class="xref py py-func docutils literal"><span class="pre">setup_logging()</span></code></a> will
set a default logger for you, so there should be no need to call this
function if you’re using setting up logging that way (recommended).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>default_logger</strong> – The logger to set to default.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="mozlog.structuredlog.get_default_logger">
<code class="descclassname">mozlog.structuredlog.</code><code class="descname">get_default_logger</code><span class="sig-paren">(</span><em>component=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.get_default_logger" title="Permalink to this definition">¶</a></dt>
<dd><p>Gets the default logger if available, optionally tagged with component
name. Will return None if not yet set</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>component</strong> – The component name to tag log messages with</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="mozlog.structuredlog.StructuredLogger">
<em class="property">class </em><code class="descclassname">mozlog.structuredlog.</code><code class="descname">StructuredLogger</code><span class="sig-paren">(</span><em>name</em>, <em>component=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger" title="Permalink to this definition">¶</a></dt>
<dd><dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.add_handler">
<code class="descname">add_handler</code><span class="sig-paren">(</span><em>handler</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.add_handler" title="Permalink to this definition">¶</a></dt>
<dd><p>Add a handler to the current logger</p>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.critical">
<code class="descname">critical</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.critical" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a message with level CRITICAL</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>message</strong> – The string message to log</li>
<li><strong>exc_info</strong> – Either a boolean indicating whether to include a traceback
derived from sys.exc_info() or a three-item tuple in the
same format as sys.exc_info() containing exception information
to log.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.debug">
<code class="descname">debug</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.debug" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a message with level DEBUG</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>message</strong> – The string message to log</li>
<li><strong>exc_info</strong> – Either a boolean indicating whether to include a traceback
derived from sys.exc_info() or a three-item tuple in the
same format as sys.exc_info() containing exception information
to log.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.error">
<code class="descname">error</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.error" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a message with level ERROR</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>message</strong> – The string message to log</li>
<li><strong>exc_info</strong> – Either a boolean indicating whether to include a traceback
derived from sys.exc_info() or a three-item tuple in the
same format as sys.exc_info() containing exception information
to log.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="attribute">
<dt id="mozlog.structuredlog.StructuredLogger.handlers">
<code class="descname">handlers</code><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.handlers" title="Permalink to this definition">¶</a></dt>
<dd><p>A list of handlers that will be called when a
message is logged from this logger</p>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.info">
<code class="descname">info</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.info" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a message with level INFO</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>message</strong> – The string message to log</li>
<li><strong>exc_info</strong> – Either a boolean indicating whether to include a traceback
derived from sys.exc_info() or a three-item tuple in the
same format as sys.exc_info() containing exception information
to log.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.process_output">
<code class="descname">process_output</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.process_output" title="Permalink to this definition">¶</a></dt>
<dd><p>Log output from a managed process.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>process</strong> – A unique identifier for the process producing the output
(typically the pid)</li>
<li><strong>data</strong> – The output to log</li>
<li><strong>command</strong> – A string representing the full command line used to start
the process.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.remove_handler">
<code class="descname">remove_handler</code><span class="sig-paren">(</span><em>handler</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.remove_handler" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove a handler from the current logger</p>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.suite_end">
<code class="descname">suite_end</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.suite_end" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a suite_end message</p>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.suite_start">
<code class="descname">suite_start</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.suite_start" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a suite_start message</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>tests</strong> (<em>dict</em>) – Test identifiers that will be run in the suite, keyed by group name.</li>
<li><strong>run_info</strong> (<em>dict</em>) – Optional information typically provided by mozinfo.</li>
<li><strong>version_info</strong> (<em>dict</em>) – Optional target application version information provided
by mozversion.</li>
<li><strong>device_info</strong> (<em>dict</em>) – Optional target device information provided by mozdevice.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.test_end">
<code class="descname">test_end</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.test_end" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a test_end message indicating that a test completed. For tests
with subtests this indicates whether the overall test completed without
errors. For tests without subtests this indicates the test result
directly.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>test</strong> – Identifier of the test that produced the result.</li>
<li><strong>status</strong> – Status string indicating the test result</li>
<li><strong>expected</strong> – Status string indicating the expected test result.</li>
<li><strong>message</strong> – String containing a message associated with the result.</li>
<li><strong>stack</strong> – a stack trace encountered during test execution.</li>
<li><strong>extra</strong> – suite-specific data associated with the test result.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.test_start">
<code class="descname">test_start</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.test_start" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a test_start message</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>test</strong> – Identifier of the test that will run.</li>
<li><strong>path</strong> – Path to test relative to some base (typically the root of
the source tree).</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.test_status">
<code class="descname">test_status</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.test_status" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a test_status message indicating a subtest result. Tests that
do not have subtests are not expected to produce test_status messages.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>test</strong> – Identifier of the test that produced the result.</li>
<li><strong>subtest</strong> – Name of the subtest.</li>
<li><strong>status</strong> – Status string indicating the subtest result</li>
<li><strong>expected</strong> – Status string indicating the expected subtest result.</li>
<li><strong>message</strong> – String containing a message associated with the result.</li>
<li><strong>stack</strong> – a stack trace encountered during test execution.</li>
<li><strong>extra</strong> – suite-specific data associated with the test result.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="mozlog.structuredlog.StructuredLogger.warning">
<code class="descname">warning</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogger.warning" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a message with level WARNING</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>message</strong> – The string message to log</li>
<li><strong>exc_info</strong> – Either a boolean indicating whether to include a traceback
derived from sys.exc_info() or a three-item tuple in the
same format as sys.exc_info() containing exception information
to log.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="mozlog.structuredlog.StructuredLogFileLike">
<em class="property">class </em><code class="descclassname">mozlog.structuredlog.</code><code class="descname">StructuredLogFileLike</code><span class="sig-paren">(</span><em>logger</em>, <em>level=u'info'</em>, <em>prefix=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.structuredlog.StructuredLogFileLike" title="Permalink to this definition">¶</a></dt>
<dd><p>Wrapper for file-like objects to redirect writes to logger
instead. Each call to <cite>write</cite> becomes a single log entry of type <cite>log</cite>.</p>
<p>When using this it is important that the callees i.e. the logging
handlers do not themselves try to write to the wrapped file as this
will cause infinite recursion.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>logger</strong> – <cite>StructuredLogger</cite> to which to redirect the file write operations.</li>
<li><strong>level</strong> – log level to use for each write.</li>
<li><strong>prefix</strong> – String prefix to prepend to each log entry.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="proxylogger-objects">
<h2>ProxyLogger Objects<a class="headerlink" href="#proxylogger-objects" title="Permalink to this headline">¶</a></h2>
<p>Since <a class="reference internal" href="#mozlog.structuredlog.get_default_logger" title="mozlog.structuredlog.get_default_logger"><code class="xref py py-func docutils literal"><span class="pre">mozlog.structuredlog.get_default_logger()</span></code></a> return None when
the default logger is not initialized, it is not possible to directly
use it at the module level.</p>
<p>With ProxyLogger, it is possible to write the following code:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mozlog</span> <span class="k">import</span> <span class="n">get_proxy_logger</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">get_proxy_logger</span><span class="p">(</span><span class="s1">&#39;component_name&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">my_function</span><span class="p">():</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;logging with a module level object&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">mozlog still needs to be initialized before the first call occurs
to a ProxyLogger instance, for example with
<a class="reference internal" href="#mozlog.commandline.setup_logging" title="mozlog.commandline.setup_logging"><code class="xref py py-func docutils literal"><span class="pre">mozlog.commandline.setup_logging()</span></code></a>.</p>
</div>
<span class="target" id="module-mozlog.proxy"></span><dl class="function">
<dt id="mozlog.proxy.get_proxy_logger">
<code class="descclassname">mozlog.proxy.</code><code class="descname">get_proxy_logger</code><span class="sig-paren">(</span><em>component=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.proxy.get_proxy_logger" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a <a class="reference internal" href="#mozlog.proxy.ProxyLogger" title="mozlog.proxy.ProxyLogger"><code class="xref py py-class docutils literal"><span class="pre">ProxyLogger</span></code></a> for the given component.</p>
</dd></dl>

<dl class="class">
<dt id="mozlog.proxy.ProxyLogger">
<em class="property">class </em><code class="descclassname">mozlog.proxy.</code><code class="descname">ProxyLogger</code><span class="sig-paren">(</span><em>component=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.proxy.ProxyLogger" title="Permalink to this definition">¶</a></dt>
<dd><p>A ProxyLogger behaves like a
<a class="reference internal" href="#mozlog.structuredlog.StructuredLogger" title="mozlog.structuredlog.StructuredLogger"><code class="xref py py-class docutils literal"><span class="pre">mozlog.structuredlog.StructuredLogger</span></code></a>.</p>
<p>Each method and attribute access will be forwarded to the underlying
StructuredLogger.</p>
<p>RuntimeError will be raised when the default logger is not yet initialized.</p>
</dd></dl>

</div>
<div class="section" id="handlers">
<h2>Handlers<a class="headerlink" href="#handlers" title="Permalink to this headline">¶</a></h2>
<p>A handler is a callable that is called for each log message produced
and is responsible for handling the processing of that
message. The typical example of this is a <code class="docutils literal"><span class="pre">StreamHandler</span></code> which takes
a log message, invokes a formatter which converts the log to a string,
and writes it to a file.</p>
<span class="target" id="module-mozlog.handlers"></span><dl class="class">
<dt id="mozlog.handlers.BaseHandler">
<em class="property">class </em><code class="descclassname">mozlog.handlers.</code><code class="descname">BaseHandler</code><span class="sig-paren">(</span><em>inner</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.handlers.BaseHandler" title="Permalink to this definition">¶</a></dt>
<dd><p>A base handler providing message handling facilities to
derived classes.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>inner</strong> – A handler-like callable that may receive messages
from a log user.</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="mozlog.handlers.BaseHandler.handle_message">
<code class="descname">handle_message</code><span class="sig-paren">(</span><em>topic</em>, <em>cmd</em>, <em>*args</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.handlers.BaseHandler.handle_message" title="Permalink to this definition">¶</a></dt>
<dd><p>Handles a message for the given topic by calling a subclass-defined
callback for the command.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>topic</strong> – The topic of the broadcasted message. Handlers opt-in to
receiving messages by identifying a topic when calling
register_message_handlers.</li>
<li><strong>command</strong> – The command to issue. This is a string that corresponds
to a callback provided by the target.</li>
<li><strong>arg</strong> – Arguments to pass to the identified message callback, if any.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="mozlog.handlers.StreamHandler">
<em class="property">class </em><code class="descclassname">mozlog.handlers.</code><code class="descname">StreamHandler</code><span class="sig-paren">(</span><em>stream</em>, <em>formatter</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.handlers.StreamHandler" title="Permalink to this definition">¶</a></dt>
<dd><p>Handler for writing to a file-like object</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>stream</strong> – File-like object to write log messages to</li>
<li><strong>formatter</strong> – formatter to convert messages to string format</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="mozlog.handlers.LogLevelFilter">
<em class="property">class </em><code class="descclassname">mozlog.handlers.</code><code class="descname">LogLevelFilter</code><span class="sig-paren">(</span><em>inner</em>, <em>level</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.handlers.LogLevelFilter" title="Permalink to this definition">¶</a></dt>
<dd><p>Handler that filters out messages with action of log and a level
lower than some specified level.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>inner</strong> – Handler to use for messages that pass this filter</li>
<li><strong>level</strong> – Minimum log level to process</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="mozlog.handlers.BufferHandler">
<em class="property">class </em><code class="descclassname">mozlog.handlers.</code><code class="descname">BufferHandler</code><span class="sig-paren">(</span><em>inner</em>, <em>message_limit=100</em>, <em>buffered_actions=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.handlers.BufferHandler" title="Permalink to this definition">¶</a></dt>
<dd><p>Handler that maintains a circular buffer of messages based on the
size and actions specified by a user.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>inner</strong> – The underlying handler used to emit messages.</li>
<li><strong>message_limit</strong> – The maximum number of messages to retain for
context. If None, the buffer will grow without limit.</li>
<li><strong>buffered_actions</strong> – The set of actions to include in the buffer
rather than log directly.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="formatters">
<h2>Formatters<a class="headerlink" href="#formatters" title="Permalink to this headline">¶</a></h2>
<p>Formatters are callables that take a log message, and return either a
string representation of that message, or <code class="docutils literal"><span class="pre">None</span></code> if that message
should not appear in the output. This allows formatters to both
exclude certain items and create internal buffers of the output so
that, for example, a single string might be returned for a
<code class="docutils literal"><span class="pre">test_end</span></code> message indicating the overall result of the test,
including data provided in the <code class="docutils literal"><span class="pre">test_status</span></code> messages.</p>
<p>Formatter modules are written so that they can take raw input on stdin
and write formatted output on stdout. This allows the formatters to be
invoked as part of a command line for post-processing raw log files.</p>
<span class="target" id="module-mozlog.formatters.base"></span><dl class="class">
<dt id="mozlog.formatters.base.BaseFormatter">
<em class="property">class </em><code class="descclassname">mozlog.formatters.base.</code><code class="descname">BaseFormatter</code><a class="headerlink" href="#mozlog.formatters.base.BaseFormatter" title="Permalink to this definition">¶</a></dt>
<dd><p>Base class for implementing non-trivial formatters.</p>
<p>Subclasses are expected to provide a method for each action type they
wish to handle, each taking a single argument for the test data.
For example a trivial subclass that just produces the id of each test as
it starts might be:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">StartIdFormatter</span><span class="p">(</span><span class="n">BaseFormatter</span><span class="p">);</span>
    <span class="k">def</span> <span class="nf">test_start</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="c1">#For simplicity in the example pretend the id is always a string</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="module-mozlog.formatters.unittest"></span><dl class="class">
<dt id="mozlog.formatters.unittest.UnittestFormatter">
<em class="property">class </em><code class="descclassname">mozlog.formatters.unittest.</code><code class="descname">UnittestFormatter</code><a class="headerlink" href="#mozlog.formatters.unittest.UnittestFormatter" title="Permalink to this definition">¶</a></dt>
<dd><p>Formatter designed to produce output in a format like that used by
the <code class="docutils literal"><span class="pre">unittest</span></code> module in the standard library.</p>
</dd></dl>

<span class="target" id="module-mozlog.formatters.xunit"></span><dl class="class">
<dt id="mozlog.formatters.xunit.XUnitFormatter">
<em class="property">class </em><code class="descclassname">mozlog.formatters.xunit.</code><code class="descname">XUnitFormatter</code><a class="headerlink" href="#mozlog.formatters.xunit.XUnitFormatter" title="Permalink to this definition">¶</a></dt>
<dd><p>Formatter that produces XUnit-style XML output.</p>
<p>The tree is created in-memory so this formatter may be problematic
with very large log files.</p>
<p>Note that the data model isn’t a perfect match. In
particular XUnit assumes that each test has a unittest-style
class name and function name, which isn’t the case for us. The
implementation currently replaces path names with something that
looks like class names, but this doesn’t work for test types that
actually produce class names, or for test types that have multiple
components in their test id (e.g. reftests).</p>
</dd></dl>

<span class="target" id="module-mozlog.formatters.html"></span><dl class="class">
<dt id="mozlog.formatters.html.HTMLFormatter">
<em class="property">class </em><code class="descclassname">mozlog.formatters.html.</code><code class="descname">HTMLFormatter</code><a class="headerlink" href="#mozlog.formatters.html.HTMLFormatter" title="Permalink to this definition">¶</a></dt>
<dd><p>Formatter that produces a simple HTML-formatted report.</p>
</dd></dl>

<span class="target" id="module-mozlog.formatters.machformatter"></span><dl class="class">
<dt id="mozlog.formatters.machformatter.MachFormatter">
<em class="property">class </em><code class="descclassname">mozlog.formatters.machformatter.</code><code class="descname">MachFormatter</code><span class="sig-paren">(</span><em>start_time=None</em>, <em>write_interval=False</em>, <em>write_times=True</em>, <em>terminal=None</em>, <em>disable_colors=False</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.formatters.machformatter.MachFormatter" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<span class="target" id="module-mozlog.formatters.tbplformatter"></span><dl class="class">
<dt id="mozlog.formatters.tbplformatter.TbplFormatter">
<em class="property">class </em><code class="descclassname">mozlog.formatters.tbplformatter.</code><code class="descname">TbplFormatter</code><span class="sig-paren">(</span><em>compact=False</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.formatters.tbplformatter.TbplFormatter" title="Permalink to this definition">¶</a></dt>
<dd><p>Formatter that formats logs in the legacy formatting format used by TBPL
This is intended to be used to preserve backward compatibility with existing tools
hand-parsing this format.</p>
</dd></dl>

</div>
<div class="section" id="processing-log-files">
<h2>Processing Log Files<a class="headerlink" href="#processing-log-files" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">mozlog.reader</span></code> module provides utilities for working
with structured log files.</p>
<span class="target" id="module-mozlog.reader"></span><dl class="class">
<dt id="mozlog.reader.LogHandler">
<em class="property">class </em><code class="descclassname">mozlog.reader.</code><code class="descname">LogHandler</code><a class="headerlink" href="#mozlog.reader.LogHandler" title="Permalink to this definition">¶</a></dt>
<dd><p>Base class for objects that act as log handlers. A handler is a callable
that takes a log entry as the only argument.</p>
<p>Subclasses are expected to provide a method for each action type they
wish to handle, each taking a single argument for the test data.
For example a trivial subclass that just produces the id of each test as
it starts might be:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">StartIdHandler</span><span class="p">(</span><span class="n">LogHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_start</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="c1">#For simplicity in the example pretend the id is always a string</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="mozlog.reader.each_log">
<code class="descclassname">mozlog.reader.</code><code class="descname">each_log</code><span class="sig-paren">(</span><em>log_iter</em>, <em>action_map</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.reader.each_log" title="Permalink to this definition">¶</a></dt>
<dd><p>Call a callback for each item in an iterable containing structured
log entries</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>log_iter</strong> – Iterator returning structured log entries</li>
<li><strong>action_map</strong> – Dictionary mapping action name to callback function. Log items
with actions not in this dictionary will be skipped.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="mozlog.reader.handle_log">
<code class="descclassname">mozlog.reader.</code><code class="descname">handle_log</code><span class="sig-paren">(</span><em>log_iter</em>, <em>handler</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.reader.handle_log" title="Permalink to this definition">¶</a></dt>
<dd><p>Call a handler for each item in a log, discarding the return value</p>
</dd></dl>

<dl class="function">
<dt id="mozlog.reader.imap_log">
<code class="descclassname">mozlog.reader.</code><code class="descname">imap_log</code><span class="sig-paren">(</span><em>log_iter</em>, <em>action_map</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.reader.imap_log" title="Permalink to this definition">¶</a></dt>
<dd><p>Create an iterator that will invoke a callback per action for each item in a
iterable containing structured log entries</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>log_iter</strong> – Iterator returning structured log entries</li>
<li><strong>action_map</strong> – Dictionary mapping action name to callback function. Log items
with actions not in this dictionary will be skipped.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="mozlog.reader.read">
<code class="descclassname">mozlog.reader.</code><code class="descname">read</code><span class="sig-paren">(</span><em>log_f</em>, <em>raise_on_error=False</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.reader.read" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a generator that will return the entries in a structured log file.
Note that the caller must not close the file whilst the generator is still
in use.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>log_f</strong> – file-like object containing the raw log entries, one per line</li>
<li><strong>raise_on_error</strong> – boolean indicating whether ValueError should be raised
for lines that cannot be decoded.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="integration-with-argparse">
<h2>Integration with argparse<a class="headerlink" href="#integration-with-argparse" title="Permalink to this headline">¶</a></h2>
<p>The <cite>mozlog.commandline</cite> module provides integration with the <cite>argparse</cite>
module to provide uniform logging-related command line arguments to programs
using <cite>mozlog</cite>. Each known formatter gets a command line argument of the form
<code class="docutils literal"><span class="pre">--log-{name}</span></code>, which takes the name of a file to log to with that format,
or <code class="docutils literal"><span class="pre">-</span></code> to indicate stdout.</p>
<span class="target" id="module-mozlog.commandline"></span><dl class="data">
<dt id="mozlog.commandline.TEXT_FORMATTERS">
<code class="descclassname">mozlog.commandline.</code><code class="descname">TEXT_FORMATTERS</code><em class="property"> = ('raw', 'mach')</em><a class="headerlink" href="#mozlog.commandline.TEXT_FORMATTERS" title="Permalink to this definition">¶</a></dt>
<dd><p>a subset of formatters for non test harnesses related applications</p>
</dd></dl>

<dl class="function">
<dt id="mozlog.commandline.add_logging_group">
<code class="descclassname">mozlog.commandline.</code><code class="descname">add_logging_group</code><span class="sig-paren">(</span><em>parser</em>, <em>include_formatters=None</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.commandline.add_logging_group" title="Permalink to this definition">¶</a></dt>
<dd><p>Add logging options to an argparse ArgumentParser or
optparse OptionParser.</p>
<p>Each formatter has a corresponding option of the form –log-{name}
where {name} is the name of the formatter. The option takes a value
which is either a filename or “-” to indicate stdout.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>parser</strong> – The ArgumentParser or OptionParser object that should have
logging options added.</li>
<li><strong>include_formatters</strong> – List of formatter names that should be included
in the option group. Default to None, meaning
all the formatters are included. A common use
of this option is to specify
<a class="reference internal" href="#mozlog.commandline.TEXT_FORMATTERS" title="mozlog.commandline.TEXT_FORMATTERS"><code class="xref py py-data docutils literal"><span class="pre">TEXT_FORMATTERS</span></code></a> to include only the
most useful formatters for a command line tool
that is not related to test harnesses.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="mozlog.commandline.setup_handlers">
<code class="descclassname">mozlog.commandline.</code><code class="descname">setup_handlers</code><span class="sig-paren">(</span><em>logger</em>, <em>formatters</em>, <em>formatter_options</em>, <em>allow_unused_options=False</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.commandline.setup_handlers" title="Permalink to this definition">¶</a></dt>
<dd><p>Add handlers to the given logger according to the formatters and
options provided.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>logger</strong> – The logger configured by this function.</li>
<li><strong>formatters</strong> – A dict of {formatter, [streams]} to use in handlers.</li>
<li><strong>formatter_options</strong> – a dict of {formatter: {option: value}} to
to use when configuring formatters.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="mozlog.commandline.setup_logging">
<code class="descclassname">mozlog.commandline.</code><code class="descname">setup_logging</code><span class="sig-paren">(</span><em>logger</em>, <em>args</em>, <em>defaults=None</em>, <em>formatter_defaults=None</em>, <em>allow_unused_options=False</em><span class="sig-paren">)</span><a class="headerlink" href="#mozlog.commandline.setup_logging" title="Permalink to this definition">¶</a></dt>
<dd><p>Configure a structuredlogger based on command line arguments.</p>
<p>The created structuredlogger will also be set as the default logger, and
can be retrieved with <code class="xref py py-func docutils literal"><span class="pre">get_default_logger()</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>logger</strong> – A StructuredLogger instance or string name. If a string, a
new StructuredLogger instance will be created using
<cite>logger</cite> as the name.</li>
<li><strong>args</strong> – A dictionary of {argument_name:value} produced from
parsing the command line arguments for the application</li>
<li><strong>defaults</strong> – A dictionary of {formatter name: output stream} to apply
when there is no logging supplied on the command line. If
this isn’t supplied, reasonable defaults are chosen
(coloured mach formatting if stdout is a terminal, or raw
logs otherwise).</li>
<li><strong>formatter_defaults</strong> – A dictionary of {option_name: default_value} to provide
to the formatters in the absence of command line overrides.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last"><a class="reference internal" href="#mozlog.structuredlog.StructuredLogger" title="mozlog.structuredlog.StructuredLogger">StructuredLogger</a></p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="simple-examples">
<h2>Simple Examples<a class="headerlink" href="#simple-examples" title="Permalink to this headline">¶</a></h2>
<p>Log to stdout:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mozlog</span> <span class="k">import</span> <span class="n">structuredlog</span>
<span class="kn">from</span> <span class="nn">mozlog</span> <span class="k">import</span> <span class="n">handlers</span><span class="p">,</span> <span class="n">formatters</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">structuredlog</span><span class="o">.</span><span class="n">StructuredLogger</span><span class="p">(</span><span class="s2">&quot;my-test-suite&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">handlers</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                          <span class="n">formatters</span><span class="o">.</span><span class="n">JSONFormatter</span><span class="p">()))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">suite_start</span><span class="p">([</span><span class="s2">&quot;test-id-1&quot;</span><span class="p">])</span>
<span class="n">logger</span><span class="o">.</span><span class="n">test_start</span><span class="p">(</span><span class="s2">&quot;test-id-1&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This is a message with action=&#39;LOG&#39; and level=&#39;INFO&#39;&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">test_status</span><span class="p">(</span><span class="s2">&quot;test-id-1&quot;</span><span class="p">,</span> <span class="s2">&quot;subtest-1&quot;</span><span class="p">,</span> <span class="s2">&quot;PASS&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">test_end</span><span class="p">(</span><span class="s2">&quot;test-id-1&quot;</span><span class="p">,</span> <span class="s2">&quot;OK&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">suite_end</span><span class="p">()</span>
</pre></div>
</div>
<p>Populate an <code class="docutils literal"><span class="pre">argparse.ArgumentParser</span></code> with logging options, and
create a logger based on the value of those options, defaulting to
JSON output on stdout if nothing else is supplied:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">mozlog</span> <span class="k">import</span> <span class="n">commandline</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="c1"># Here one would populate the parser with other options</span>
<span class="n">commandline</span><span class="o">.</span><span class="n">add_logging_group</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">commandline</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;testsuite-name&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">})</span>
</pre></div>
</div>
<p>Count the number of tests that timed out in a testsuite:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mozlog</span> <span class="k">import</span> <span class="n">reader</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">handle_test_end</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">count</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TIMEOUT&quot;</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">reader</span><span class="o">.</span><span class="n">each_log</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;my_test_run.log&quot;</span><span class="p">),</span>
                <span class="p">{</span><span class="s2">&quot;test_end&quot;</span><span class="p">:</span> <span class="n">handle_test_end</span><span class="p">})</span>

<span class="nb">print</span> <span class="n">count</span>
</pre></div>
</div>
</div>
<div class="section" id="more-complete-example">
<h2>More Complete Example<a class="headerlink" href="#more-complete-example" title="Permalink to this headline">¶</a></h2>
<p>This example shows a complete toy testharness set up to used
structured logging. It is avaliable as <a class="reference external" href="_static/structured_example.py">structured_example.py</a>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="kn">from</span> <span class="nn">mozlog</span> <span class="k">import</span> <span class="n">commandline</span><span class="p">,</span> <span class="n">get_default_logger</span>


<span class="k">class</span> <span class="nc">TestAssertion</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">assert_equals</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TestAssertion</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> not equal to </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">expected</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">test_func</span><span class="p">():</span>
            <span class="n">f</span><span class="p">()</span>
        <span class="n">test_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">test_func</span><span class="o">.</span><span class="n">_expected</span> <span class="o">=</span> <span class="n">status</span>
        <span class="k">return</span> <span class="n">test_func</span>
    <span class="k">return</span> <span class="n">inner</span>


<span class="k">def</span> <span class="nf">test_that_passes</span><span class="p">():</span>
    <span class="n">assert_equals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">test_that_fails</span><span class="p">():</span>
    <span class="n">assert_equals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">test_that_has_an_error</span><span class="p">():</span>
    <span class="n">assert_equals</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>


<span class="nd">@expected</span><span class="p">(</span><span class="s2">&quot;FAIL&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_expected_fail</span><span class="p">():</span>
    <span class="n">assert_equals</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestRunner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_default_logger</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;TestRunner&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">gather_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">item</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">item</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gather_tests</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">suite_start</span><span class="p">(</span><span class="n">tests</span><span class="o">=</span><span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running tests&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">suite_end</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">test_start</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">_expected</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;_expected&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;PASS&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">TestAssertion</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;FAIL&quot;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ERROR&quot;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;PASS&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">test_end</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_parser</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">parser</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">get_parser</span><span class="p">()</span>
    <span class="n">commandline</span><span class="o">.</span><span class="n">add_logging_group</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">commandline</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;structured-example&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">})</span>

    <span class="n">runner</span> <span class="o">=</span> <span class="n">TestRunner</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Error during test run:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Each global function with a name starting
<code class="docutils literal"><span class="pre">test_</span></code> represents a test. A passing test returns without
throwing. A failing test throws a <code class="xref py py-class docutils literal"><span class="pre">TestAssertion</span></code> exception
via the <code class="xref py py-func docutils literal"><span class="pre">assert_equals()</span></code> function. Throwing anything else is
considered an error in the test. There is also a <code class="xref py py-func docutils literal"><span class="pre">expected()</span></code>
decorator that is used to annotate tests that are expected to do
something other than pass.</p>
<p>The main entry point to the test runner is via that <code class="xref py py-func docutils literal"><span class="pre">main()</span></code>
function. This is responsible for parsing command line
arguments, and initiating the test run. Although the test harness
itself does not provide any command line arguments, the
<code class="xref py py-class docutils literal"><span class="pre">ArgumentParser</span></code> object is populated by
<code class="xref py py-meth docutils literal"><span class="pre">commandline.add_logging_group()</span></code>, which provides a generic
set of structured logging arguments appropriate to all tools producing
structured logging.</p>
<p>The values of these command line arguments are used to create a
<code class="xref py py-class docutils literal"><span class="pre">mozlog.StructuredLogger</span></code> object populated with the
specified handlers and formatters in
<code class="xref py py-func docutils literal"><span class="pre">commandline.setup_logging()</span></code>. The third argument to this
function is the default arguments to use. In this case the default
is to output raw (i.e. JSON-formatted) logs to stdout.</p>
<p>The main test harness is provided by the <code class="xref py py-class docutils literal"><span class="pre">TestRunner</span></code>
class. This class is responsible for scheduling all the tests and
logging all the results. It is passed the <code class="xref py py-obj docutils literal"><span class="pre">logger</span></code> object
created from the command line arguments. The <code class="xref py py-meth docutils literal"><span class="pre">run()</span></code> method
starts the test run. Before the run is started it logs a
<code class="docutils literal"><span class="pre">suite_start</span></code> message containing the id of each test that will run,
and after the testrun is done it logs a <code class="docutils literal"><span class="pre">suite_end</span></code> message.</p>
<p>Individual tests are run in the <code class="xref py py-meth docutils literal"><span class="pre">run_test()</span></code> method. For each
test this logs a <code class="docutils literal"><span class="pre">test_start</span></code> message. It then runs the test and
logs a <code class="docutils literal"><span class="pre">test_end</span></code> message containing the test name, status, expected
status, and any informational message about the reason for the
result. In this test harness there are no subtests, so the
<code class="docutils literal"><span class="pre">test_end</span></code> message has the status of the test and there are no
<code class="docutils literal"><span class="pre">test_status</span></code> messages.</p>
<div class="section" id="example-output">
<h3>Example Output<a class="headerlink" href="#example-output" title="Permalink to this headline">¶</a></h3>
<p>When run without providing any command line options, the raw
structured log messages are sent to stdout:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ python structured_example.py

{&quot;source&quot;: &quot;structured-example&quot;, &quot;tests&quot;: [&quot;test_that_has_an_error&quot;, &quot;test_that_fails&quot;, &quot;test_expected_fail&quot;, &quot;test_that_passes&quot;], &quot;thread&quot;: &quot;MainThread&quot;, &quot;time&quot;: 1401446682787, &quot;action&quot;: &quot;suite_start&quot;, &quot;pid&quot;: 18456}
{&quot;source&quot;: &quot;structured-example&quot;, &quot;thread&quot;: &quot;MainThread&quot;, &quot;time&quot;: 1401446682787, &quot;action&quot;: &quot;log&quot;, &quot;message&quot;: &quot;Running tests&quot;, &quot;level&quot;: &quot;INFO&quot;, &quot;pid&quot;: 18456}
{&quot;source&quot;: &quot;structured-example&quot;, &quot;test&quot;: &quot;test_that_has_an_error&quot;, &quot;thread&quot;: &quot;MainThread&quot;, &quot;time&quot;: 1401446682787, &quot;action&quot;: &quot;test_start&quot;, &quot;pid&quot;: 18456}
{&quot;status&quot;: &quot;ERROR&quot;, &quot;thread&quot;: &quot;MainThread&quot;, &quot;pid&quot;: 18456, &quot;source&quot;: &quot;structured-example&quot;, &quot;test&quot;: &quot;test_that_has_an_error&quot;, &quot;time&quot;: 1401446682788, &quot;action&quot;: &quot;test_end&quot;, &quot;message&quot;: &quot;Traceback (most recent call last):\n  File \&quot;structured_example.py\&quot;, line 61, in run_test\n    func()\n  File \&quot;structured_example.py\&quot;, line 31, in test_that_has_an_error\n    assert_equals(2, 1 + \&quot;1\&quot;)\nTypeError: unsupported operand type(s) for +: &#39;int&#39; and &#39;str&#39;\n&quot;, &quot;expected&quot;: &quot;PASS&quot;}
{&quot;source&quot;: &quot;structured-example&quot;, &quot;test&quot;: &quot;test_that_fails&quot;, &quot;thread&quot;: &quot;MainThread&quot;, &quot;time&quot;: 1401446682788, &quot;action&quot;: &quot;test_start&quot;, &quot;pid&quot;: 18456}
{&quot;status&quot;: &quot;FAIL&quot;, &quot;thread&quot;: &quot;MainThread&quot;, &quot;pid&quot;: 18456, &quot;source&quot;: &quot;structured-example&quot;, &quot;test&quot;: &quot;test_that_fails&quot;, &quot;time&quot;: 1401446682788, &quot;action&quot;: &quot;test_end&quot;, &quot;message&quot;: &quot;1 not equal to 2&quot;, &quot;expected&quot;: &quot;PASS&quot;}
{&quot;source&quot;: &quot;structured-example&quot;, &quot;test&quot;: &quot;test_expected_fail&quot;, &quot;thread&quot;: &quot;MainThread&quot;, &quot;time&quot;: 1401446682788, &quot;action&quot;: &quot;test_start&quot;, &quot;pid&quot;: 18456}
{&quot;status&quot;: &quot;FAIL&quot;, &quot;thread&quot;: &quot;MainThread&quot;, &quot;pid&quot;: 18456, &quot;source&quot;: &quot;structured-example&quot;, &quot;test&quot;: &quot;test_expected_fail&quot;, &quot;time&quot;: 1401446682788, &quot;action&quot;: &quot;test_end&quot;, &quot;message&quot;: &quot;4 not equal to 5&quot;}
{&quot;source&quot;: &quot;structured-example&quot;, &quot;test&quot;: &quot;test_that_passes&quot;, &quot;thread&quot;: &quot;MainThread&quot;, &quot;time&quot;: 1401446682788, &quot;action&quot;: &quot;test_start&quot;, &quot;pid&quot;: 18456}
{&quot;status&quot;: &quot;PASS&quot;, &quot;source&quot;: &quot;structured-example&quot;, &quot;test&quot;: &quot;test_that_passes&quot;, &quot;thread&quot;: &quot;MainThread&quot;, &quot;time&quot;: 1401446682789, &quot;action&quot;: &quot;test_end&quot;, &quot;pid&quot;: 18456}
{&quot;action&quot;: &quot;suite_end&quot;, &quot;source&quot;: &quot;structured-example&quot;, &quot;pid&quot;: 18456, &quot;thread&quot;: &quot;MainThread&quot;, &quot;time&quot;: 1401446682789}
</pre></div>
</div>
<p>The structured logging module provides a number of command line
options:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ python structured_example.py --help

usage: structured_example.py [-h] [--log-unittest LOG_UNITTEST]
                             [--log-raw LOG_RAW] [--log-html LOG_HTML]
                             [--log-xunit LOG_XUNIT]
                             [--log-mach LOG_MACH]

optional arguments:
  -h, --help            show this help message and exit

Output Logging:
  Options for logging output. Each option represents a possible logging
  format and takes a filename to write that format to, or &#39;-&#39; to write to
  stdout.

  --log-unittest LOG_UNITTEST
                        Unittest style output
  --log-raw LOG_RAW     Raw structured log messages
  --log-html LOG_HTML   HTML report
  --log-xunit LOG_XUNIT
                        xUnit compatible XML
  --log-mach LOG_MACH   Human-readable output
</pre></div>
</div>
<p>In order to get human-readable output on stdout and the structured log
data to go to the file <code class="docutils literal"><span class="pre">structured.log</span></code>, we would run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ python structured_example.py --log-mach=- --log-raw=structured.log

0:00.00 SUITE_START: MainThread 4
0:01.00 LOG: MainThread INFO Running tests
0:01.00 TEST_START: MainThread test_that_has_an_error
0:01.00 TEST_END: MainThread Harness status ERROR, expected PASS. Subtests passed 0/0. Unexpected 1
0:01.00 TEST_START: MainThread test_that_fails
0:01.00 TEST_END: MainThread Harness status FAIL, expected PASS. Subtests passed 0/0. Unexpected 1
0:01.00 TEST_START: MainThread test_expected_fail
0:02.00 TEST_END: MainThread Harness status FAIL. Subtests passed 0/0. Unexpected 0
0:02.00 TEST_START: MainThread test_that_passes
0:02.00 TEST_END: MainThread Harness status PASS. Subtests passed 0/0. Unexpected 0
0:02.00 SUITE_END: MainThread
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../python/mach/index.html" class="btn btn-neutral float-right" title="mach" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="loggingreporting.html" class="btn btn-neutral" title="Logging and reporting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright .

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'59.0a1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>