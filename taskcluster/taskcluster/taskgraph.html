

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Overview &mdash; Mozilla Source Tree Docs 59.0a1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Mozilla Source Tree Docs 59.0a1 documentation" href="../../index.html"/>
        <link rel="up" title="TaskCluster Task-Graph Generation" href="index.html"/>
        <link rel="next" title="Mach commands" href="mach.html"/>
        <link rel="prev" title="TaskCluster Task-Graph Generation" href="index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Mozilla Source Tree Docs
          

          
          </a>

          
            
            
              <div class="version">
                59.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../browser/base/sslerrorreport/index.html">SSL Error Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../browser/browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../browser/experiments/experiments/index.html">Telemetry Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/fennec/index.html">Firefox for Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/fennec/index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mach/index.html">mach</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">TaskCluster Task-Graph Generation</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#concepts">Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kinds">Kinds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#decision-task">Decision Task</a></li>
<li class="toctree-l3"><a class="reference internal" href="#graph-generation">Graph Generation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#transitive-closure">Transitive Closure</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#action-tasks">Action Tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#task-parameterization">Task Parameterization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#graph-configuration">Graph Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#trust-domain">Trust Domain</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mach.html">Mach commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading.html">Loading Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="transforms.html">Transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimization.html">Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="docker-images.html">Docker Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="cron.html">Periodic Taskgraphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="try.html">Try</a></li>
<li class="toctree-l2"><a class="reference internal" href="actions.html">Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-tos.html">How Tos</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference.html">Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/crashes/crash-manager/index.html">Crash Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/extensions/webextensions/index.html">WebExtensions API Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/payments/docs/index.html">WebPayments UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/telemetry/telemetry/index.html">Telemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/components/url-classifier/url-classifier/index.html">URL Classifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/crashreporter/crashreporter/index.html">Crash Reporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/modules/subprocess/toolkit_modules/subprocess/index.html">Supbrocess Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/modules/toolkit_modules/index.html">Toolkit modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/mozapps/extensions/addon-manager/index.html">Add-on Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/compare-locales/index.html">Localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/lint/index.html">Linting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/lint/index.html#indices-and-tables">Indices and tables</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../python/mach.html">mach package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozbuild.html">mozbuild package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozlint.html">mozlint package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozpack.html">mozpack package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozversioncontrol.html">mozversioncontrol package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/mozwebidlcodegen.html">mozwebidlcodegen package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/taskgraph.html">taskgraph package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Mozilla Source Tree Docs</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">TaskCluster Task-Graph Generation</a> &raquo;</li>
        
      <li>Overview</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/taskcluster/taskcluster/taskgraph.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h1>
<p>The task graph is built by linking different kinds of tasks together, pruning
out tasks that are not required, then optimizing by replacing subgraphs with
links to already-completed tasks.</p>
<div class="section" id="concepts">
<h2>Concepts<a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><em>Task Kind</em> - Tasks are grouped by kind, where tasks of the same kind
have substantial similarities or share common processing logic. Kinds
are the primary means of supporting diversity, in that a developer can
add a new kind to do just about anything without impacting other kinds.</li>
<li><em>Task Attributes</em> - Tasks have string attributes by which can be used for
filtering.  Attributes are documented in <a class="reference internal" href="attributes.html"><span class="doc">Task Attributes</span></a>.</li>
<li><em>Task Labels</em> - Each task has a unique identifier within the graph that is
stable across runs of the graph generation algorithm.  Labels are replaced
with TaskCluster TaskIds at the latest time possible, facilitating analysis
of graphs without distracting noise from randomly-generated taskIds.</li>
<li><em>Optimization</em> - replacement of a task in a graph with an equivalent,
already-completed task, or a null task, avoiding repetition of work.</li>
</ul>
</div>
<div class="section" id="kinds">
<h2>Kinds<a class="headerlink" href="#kinds" title="Permalink to this headline">¶</a></h2>
<p>Kinds are the focal point of this system.  They provide an interface between
the large-scale graph-generation process and the small-scale task-definition
needs of different kinds of tasks.  Each kind may implement task generation
differently.  Some kinds may generate task definitions entirely internally (for
example, symbol-upload tasks are all alike, and very simple), while other kinds
may do little more than parse a directory of YAML files.</p>
<p>A <code class="docutils literal"><span class="pre">kind.yml</span></code> file contains data about the kind, as well as referring to a
Python class implementing the kind in its <code class="docutils literal"><span class="pre">implementation</span></code> key.  That
implementation may rely on lots of code shared with other kinds, or contain a
completely unique implementation of some functionality.</p>
<p>The full list of pre-defined keys in this file is:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">implementation</span></code></dt>
<dd>Class implementing this kind, in the form <code class="docutils literal"><span class="pre">&lt;module-path&gt;:&lt;object-path&gt;</span></code>.
This class should be a subclass of <code class="docutils literal"><span class="pre">taskgraph.kind.base:Kind</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">kind-dependencies</span></code></dt>
<dd>Kinds which should be loaded before this one.  This is useful when the kind
will use the list of already-created tasks to determine which tasks to
create, for example adding an upload-symbols task after every build task.</dd>
</dl>
<p>Any other keys are subject to interpretation by the kind implementation.</p>
<p>The result is a segmentation of implementation so that the more esoteric
in-tree projects can do their crazy stuff in an isolated kind without making
the bread-and-butter build and test configuration more complicated.</p>
</div>
<div class="section" id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h2>
<p>Dependencies between tasks are represented as labeled edges in the task graph.
For example, a test task must depend on the build task creating the artifact it
tests, and this dependency edge is named ‘build’.  The task graph generation
process later resolves these dependencies to specific taskIds.</p>
</div>
<div class="section" id="decision-task">
<h2>Decision Task<a class="headerlink" href="#decision-task" title="Permalink to this headline">¶</a></h2>
<p>The decision task is the first task created when a new graph begins.  It is
responsible for creating the rest of the task graph.</p>
<p>The decision task for pushes is defined in-tree, in <code class="docutils literal"><span class="pre">.taskcluster.yml</span></code>.  That
task description invokes <code class="docutils literal"><span class="pre">mach</span> <span class="pre">taskcluster</span> <span class="pre">decision</span></code> with some metadata about
the push.  That mach command determines the optimized task graph, then calls
the TaskCluster API to create the tasks.</p>
<p>Note that this mach command is <em>not</em> designed to be invoked directly by humans.
Instead, use the mach commands described below, supplying <code class="docutils literal"><span class="pre">parameters.yml</span></code>
from a recent decision task.  These commands allow testing everything the
decision task does except the command-line processing and the
<code class="docutils literal"><span class="pre">queue.createTask</span></code> calls.</p>
</div>
<div class="section" id="graph-generation">
<h2>Graph Generation<a class="headerlink" href="#graph-generation" title="Permalink to this headline">¶</a></h2>
<p>Graph generation, as run via <code class="docutils literal"><span class="pre">mach</span> <span class="pre">taskgraph</span> <span class="pre">decision</span></code>, proceeds as follows:</p>
<ol class="arabic simple">
<li>For all kinds, generate all tasks.  The result is the “full task set”</li>
<li>Create dependency links between tasks using kind-specific mechanisms.  The
result is the “full task graph”.</li>
<li>Filter the target tasks (based on a series of filters, such as try syntax,
tree-specific specifications, etc). The result is the “target task set”.</li>
<li>Based on the full task graph, calculate the transitive closure of the target
task set.  That is, the target tasks and all requirements of those tasks.
The result is the “target task graph”.</li>
<li>Optimize the target task graph using task-specific optimization methods.
The result is the “optimized task graph” with fewer nodes than the target
task graph.  See <span class="xref std std-ref">optimization</span>.</li>
<li>Morph the graph. Morphs are like syntactic sugar: they keep the same meaning,
but express it in a lower-level way. These generally work around limitations
in the TaskCluster platform, such as number of dependencies or routes in
a task.</li>
<li>Create tasks for all tasks in the morphed task graph.</li>
</ol>
<div class="section" id="transitive-closure">
<h3>Transitive Closure<a class="headerlink" href="#transitive-closure" title="Permalink to this headline">¶</a></h3>
<p>Transitive closure is a fancy name for this sort of operation:</p>
<blockquote>
<div><ul class="simple">
<li>start with a set of tasks</li>
<li>add all tasks on which any of those tasks depend</li>
<li>repeat until nothing changes</li>
</ul>
</div></blockquote>
<p>The effect is this: imagine you start with a linux32 test job and a linux64 test job.
In the first round, each test task depends on the test docker image task, so add that image task.
Each test also depends on a build, so add the linux32 and linux64 build tasks.</p>
<p>Then repeat: the test docker image task is already present, as are the build
tasks, but those build tasks depend on the build docker image task.  So add
that build docker image task.  Repeat again: this time, none of the tasks in
the set depend on a task not in the set, so nothing changes and the process is
complete.</p>
<p>And as you can see, the graph we’ve built now includes everything we wanted
(the test jobs) plus everything required to do that (docker images, builds).</p>
</div>
</div>
<div class="section" id="action-tasks">
<h2>Action Tasks<a class="headerlink" href="#action-tasks" title="Permalink to this headline">¶</a></h2>
<p>Action Tasks are tasks which help you to schedule new jobs via Treeherder’s
“Add New Jobs” feature. The Decision Task creates a YAML file named
<code class="docutils literal"><span class="pre">action.yml</span></code> which can be used to schedule Action Tasks after suitably replacing
<code class="docutils literal"><span class="pre">{{decision_task_id}}</span></code> and <code class="docutils literal"><span class="pre">{{task_labels}}</span></code>, which correspond to the decision
task ID of the push and a comma separated list of task labels which need to be
scheduled.</p>
<p>This task invokes <code class="docutils literal"><span class="pre">mach</span> <span class="pre">taskgraph</span> <span class="pre">action-task</span></code> which builds up a task graph of
the requested tasks. This graph is optimized using the tasks running initially in
the same push, due to the decision task.</p>
<p>So for instance, if you had already requested a build task in the <code class="docutils literal"><span class="pre">try</span></code> command,
and you wish to add a test which depends on this build, the original build task
is re-used.</p>
<p>Action Tasks are currently scheduled by
[pulse_actions](<a class="reference external" href="https://github.com/mozilla/pulse_actions">https://github.com/mozilla/pulse_actions</a>). This feature is only
present on <code class="docutils literal"><span class="pre">try</span></code> pushes for now.</p>
</div>
<div class="section" id="task-parameterization">
<h2>Task Parameterization<a class="headerlink" href="#task-parameterization" title="Permalink to this headline">¶</a></h2>
<p>A few components of tasks are only known at the very end of the decision task
– just before the <code class="docutils literal"><span class="pre">queue.createTask</span></code> call is made.  These are specified
using simple parameterized values, as follows:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">{&quot;relative-datestamp&quot;:</span> <span class="pre">&quot;certain</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">seconds/hours/days/years&quot;}</span></code></dt>
<dd>Objects of this form will be replaced with an offset from the current time
just before the <code class="docutils literal"><span class="pre">queue.createTask</span></code> call is made.  For example, an
artifact expiration might be specified as <code class="docutils literal"><span class="pre">{&quot;relative-datestamp&quot;:</span> <span class="pre">&quot;1</span>
<span class="pre">year&quot;}</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">{&quot;task-reference&quot;:</span> <span class="pre">&quot;string</span> <span class="pre">containing</span> <span class="pre">&lt;dep-name&gt;&quot;}</span></code></dt>
<dd>The task definition may contain “task references” of this form.  These will
be replaced during the optimization step, with the appropriate taskId for
the named dependency substituted for <code class="docutils literal"><span class="pre">&lt;dep-name&gt;</span></code> in the string.
Multiple labels may be substituted in a single string, and <code class="docutils literal"><span class="pre">&lt;&lt;&gt;</span></code> can be
used to escape a literal <code class="docutils literal"><span class="pre">&lt;</span></code>.</dd>
</dl>
</div>
<div class="section" id="graph-configuration">
<h2>Graph Configuration<a class="headerlink" href="#graph-configuration" title="Permalink to this headline">¶</a></h2>
<p>There are several configuration settings that are pertain to the entire
taskgraph. These are specified in <code class="file docutils literal"><span class="pre">config.yml</span></code> at the root of the
taskgraph configuration (typically <code class="file docutils literal"><span class="pre">taskcluster/ci</span></code>). The available
settings are documented inline in <a class="reference external" href="https://dxr.mozilla.org/mozilla-central/source/taskcluster/taskgraph/config.py">taskcluster/taskgraph/config.py</a>.</p>
</div>
<div class="section" id="trust-domain">
<span id="taskgraph-trust-domain"></span><h2>Trust Domain<a class="headerlink" href="#trust-domain" title="Permalink to this headline">¶</a></h2>
<p>When publishing and signing releases, that tasks verify their definition and
all upstream tasks come from a decision task based on a trusted tree. (see
<cite>chain-of-trust verification &lt;http://scriptworker.readthedocs.io/en/latest/chain_of_trust.html&gt;</cite>).
Firefox and Thunderbird share the taskgraph code and in particular, they have
separate taskgraph configurations and in particular distinct decision tasks.
Although they use identical docker images and toolchains, in order to track the
province of those artifacts when verifying the chain of trust, they use
different index paths to cache those artifacts. The <code class="docutils literal"><span class="pre">trust-domain</span></code> graph
configuration controls the base path for indexing these cached artifacts.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="mach.html" class="btn btn-neutral float-right" title="Mach commands" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="TaskCluster Task-Graph Generation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright .

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'59.0a1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>