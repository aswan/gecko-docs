

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Histograms &mdash; Mozilla Source Tree Docs 59.0a1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../../search.html"/>
    <link rel="top" title="Mozilla Source Tree Docs 59.0a1 documentation" href="../../../../../index.html"/>
        <link rel="up" title="Data collection" href="index.html"/>
        <link rel="next" title="Events" href="events.html"/>
        <link rel="prev" title="Scalars" href="scalars.html"/> 

  
  <script src="../../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../../index.html" class="icon icon-home"> Mozilla Source Tree Docs
          

          
          </a>

          
            
            
              <div class="version">
                59.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../browser/base/sslerrorreport/index.html">SSL Error Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../browser/browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../browser/experiments/experiments/index.html">Telemetry Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../gfx/gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mobile/android/fennec/index.html">Firefox for Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mobile/android/fennec/index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mozbase/index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/mach/index.html">mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../taskcluster/taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../testing/geckodriver/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../testing/marionette/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../crashes/crash-manager/index.html">Crash Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extensions/webextensions/index.html">WebExtensions API Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../payments/docs/index.html">WebPayments UI</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Telemetry</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../concepts/index.html">Concepts</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Data collection</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="scalars.html">Scalars</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Histograms</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#choosing-a-histogram-type">Choosing a Histogram Type</a></li>
<li class="toctree-l4"><a class="reference internal" href="#declaring-a-histogram">Declaring a Histogram</a></li>
<li class="toctree-l4"><a class="reference internal" href="#changing-a-histogram">Changing a histogram</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-a-javascript-probe">Adding a JavaScript Probe</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-a-c-probe">Adding a C++ Probe</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="events.html">Events</a></li>
<li class="toctree-l3"><a class="reference internal" href="measuring-time.html">Measuring elapsed time</a></li>
<li class="toctree-l3"><a class="reference internal" href="custom-pings.html">Submitting custom pings</a></li>
<li class="toctree-l3"><a class="reference internal" href="stack-capture.html">Stack capture</a></li>
<li class="toctree-l3"><a class="reference internal" href="experiments.html">Experiment Annotation</a></li>
<li class="toctree-l3"><a class="reference internal" href="uptake.html">Uptake Telemetry</a></li>
<li class="toctree-l3"><a class="reference internal" href="use-counters.html">Use Counters</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#browser-usage-telemetry">Browser Usage Telemetry</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../data/index.html">Data documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/index.html">Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fhr/index.html">Firefox Health Report (Obsolete)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../url-classifier/url-classifier/index.html">URL Classifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../crashreporter/crashreporter/index.html">Crash Reporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/subprocess/toolkit_modules/subprocess/index.html">Supbrocess Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/toolkit_modules/index.html">Toolkit modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mozapps/extensions/addon-manager/index.html">Add-on Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/compare-locales/index.html">Localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/lint/index.html">Linting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/lint/index.html#indices-and-tables">Indices and tables</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/mach.html">mach package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/mozbuild.html">mozbuild package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/mozlint.html">mozlint package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/mozpack.html">mozpack package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/mozversioncontrol.html">mozversioncontrol package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/mozwebidlcodegen.html">mozwebidlcodegen package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/taskgraph.html">taskgraph package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Mozilla Source Tree Docs</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Telemetry</a> &raquo;</li>
        
          <li><a href="index.html">Data collection</a> &raquo;</li>
        
      <li>Histograms</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../../_sources/toolkit/components/telemetry/telemetry/collection/histograms.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="histograms">
<h1>Histograms<a class="headerlink" href="#histograms" title="Permalink to this headline">¶</a></h1>
<p>In Firefox, the Telemetry system collects various measures of Firefox performance, hardware, usage and customizations and submits it to Mozilla. The Telemetry data collected by a single client can be examined from the integrated <code class="docutils literal"><span class="pre">about:telemetry</span></code> browser page, while the aggregated reports across entire user populations are publicly available at <a class="reference external" href="https://telemetry.mozilla.org">telemetry.mozilla.org</a>.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Every new data collection in Firefox needs a <a class="reference external" href="https://wiki.mozilla.org/Firefox/Data_Collection#Requesting_Approval">data collection review</a> from a data collection peer. Just set the feedback? flag for one of the data peers. We try to reply within a business day.</p>
</div>
<p>The following sections explain how to add a new measurement to Telemetry.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Telemetry histograms are an efficient way to collect numeric measurements like multiple counts or timings.
They are collected through a common API and automatically submitted with the <a class="reference internal" href="../data/main-ping.html"><span class="doc">main ping</span></a>.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">Before adding a new histogram, you should consider using other collection mechanisms. For example, if the need is to track a single scalar value (e.g. number, boolean or string), you should use <a class="reference internal" href="scalars.html"><span class="doc">Scalars</span></a>.</p>
</div>
<p>The histogram below is taken from Firefox’s <code class="docutils literal"><span class="pre">about:telemetry</span></code> page. It shows a histogram used for tracking plugin shutdown times and the data collected over a single Firefox session. The timing data is grouped into buckets where the height of the blue bars represents the number of items in each bucket. The tallest bar, for example, indicates that there were 63 plugin shutdowns lasting between 129ms and 204ms.</p>
<img alt="../../../../../_images/sampleHistogram.png" src="../../../../../_images/sampleHistogram.png" />
<p>The histograms on the <code class="docutils literal"><span class="pre">about:telemetry</span></code> page only show the non-empty buckets in a histogram, except for the bucket to the left of the first non-empty bucket and the bucket to the right of the last non-empty bucket.</p>
</div>
<div class="section" id="choosing-a-histogram-type">
<span id="choosing-histogram-type"></span><h2>Choosing a Histogram Type<a class="headerlink" href="#choosing-a-histogram-type" title="Permalink to this headline">¶</a></h2>
<p>The first step to adding a new histogram is to choose the histogram type that best represents the data being measured. The sample histogram used above is an “exponential” histogram.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ony <code class="docutils literal"><span class="pre">flag</span></code> and <code class="docutils literal"><span class="pre">count</span></code> histograms have default values. All other histograms start out empty and are only submitted if a value is recorded.</p>
</div>
<div class="section" id="boolean">
<h3><code class="docutils literal"><span class="pre">boolean</span></code><a class="headerlink" href="#boolean" title="Permalink to this headline">¶</a></h3>
<p>These histograms only record boolean values. Multiple boolean entries can be recorded in the same histogram during a single browsing session, e.g. if a histogram is measuring user choices in a dialog box with options “Yes” or “No”, a new boolean value is added every time the dialog is displayed.</p>
</div>
<div class="section" id="linear">
<h3><code class="docutils literal"><span class="pre">linear</span></code><a class="headerlink" href="#linear" title="Permalink to this headline">¶</a></h3>
<p>Linear histograms are similar to enumerated histograms, except each bucket is associated with a range of values instead of a single enum value. The range of values covered by each bucket increases linearly from the previous bucket, e.g. one bucket might count the number of occurrences of values between 0 to 9, the next bucket would cover values 10-19, the next 20-29, etc. This bucket type is useful if there aren’t orders of magnitude differences between the minimum and maximum values stored in the histogram, e.g. if the values you are storing are percentages 0-100%.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you need a linear histogram with buckets &lt; 0, 1, 2 … N &gt;, then you should declare an enumerated histogram. This restriction was added to prevent developers from making a common off-by-one mistake when specifying the number of buckets in a linear histogram.</p>
</div>
</div>
<div class="section" id="exponential">
<h3><code class="docutils literal"><span class="pre">exponential</span></code><a class="headerlink" href="#exponential" title="Permalink to this headline">¶</a></h3>
<p>Exponential histograms are similar to linear histograms but the range of values covered by each bucket increases exponentially. As an example of its use, consider the timings of an I/O operation whose duration might normally fall in the range of 0ms-50ms but extreme cases might have durations in seconds or minutes. For such measurements, you would want finer-grained bucketing in the normal range but coarser-grained bucketing for the extremely large values. An exponential histogram fits this requirement since it has “narrow” buckets near the minimum value and significantly “wider” buckets near the maximum value.</p>
</div>
<div class="section" id="categorical">
<h3><code class="docutils literal"><span class="pre">categorical</span></code><a class="headerlink" href="#categorical" title="Permalink to this headline">¶</a></h3>
<p>Categorical histograms are similar to enumerated histograms. However, instead of specifying <code class="docutils literal"><span class="pre">n_buckets</span></code>, you specify an array of strings in the <code class="docutils literal"><span class="pre">labels</span></code> field. From JavaScript, the label values or their indices can be passed as strings to <code class="docutils literal"><span class="pre">histogram.add()</span></code>. From C++ you can use <code class="docutils literal"><span class="pre">AccumulateCategorical</span></code> with passing a value from the corresponding <code class="docutils literal"><span class="pre">Telemetry::LABEL_*</span></code> enum, or, in exceptional cases the string values.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Categorical histograms by default support up to 50 labels, but you can set it higher using the <cite>n_values</cite> property. If you need to add more labels later, you need to use a new histogram name. The current Telemetry server does not support changing histogram declarations after the histogram has already been released. See <a class="reference internal" href="#changing-a-histogram">Changing a histogram</a> if you need to add more labels later.</p>
</div>
</div>
<div class="section" id="enumerated">
<h3><code class="docutils literal"><span class="pre">enumerated</span></code><a class="headerlink" href="#enumerated" title="Permalink to this headline">¶</a></h3>
<p>This histogram type is intended for storing “enum” values, when you can’t specify labels and thus cannot use <code class="docutils literal"><span class="pre">categorical</span></code> histograms. An enumerated histogram consists of a fixed number of <em>buckets</em> (specified by <code class="docutils literal"><span class="pre">n_values</span></code>), each of which is associated with a consecutive integer value (the bucket’s <em>label</em>), <cite>0</cite> to <cite>n_values</cite>. Each bucket corresponds to an enum value and counts the number of times its particular enum value was recorded; except for the <cite>n_values</cite> bucket, which counts all values greater than or equal to n_values.</p>
<p>You might use this type of histogram if, for example, you wanted to track the relative popularity of SSL handshake types. Whenever the browser started an SSL handshake, it would record one of a limited number of enum values which uniquely identifies the handshake type.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Set <code class="docutils literal"><span class="pre">n_values</span></code> to a slightly larger value than needed to allow for new enum values in the future. See <a class="reference internal" href="#changing-a-histogram">Changing a histogram</a> if you need to add more enums later.</p>
</div>
</div>
<div class="section" id="flag">
<h3><code class="docutils literal"><span class="pre">flag</span></code><a class="headerlink" href="#flag" title="Permalink to this headline">¶</a></h3>
<p><em>Deprecated</em> (please use boolean <a class="reference internal" href="scalars.html"><span class="doc">Scalars</span></a>).</p>
<p>This histogram type allows you to record a single value (<cite>0</cite> or <cite>1</cite>, default <cite>0</cite>). This type is useful if you need to track whether a feature was ever used during a Firefox session. You only need to add a single line of code which sets the flag when the feature is used because the histogram is initialized with a default value of <cite>0</cite>/<cite>false</cite> (flag not set). Thus, recording a value of <cite>0</cite> is not allowed and asserts.</p>
<p>Flag histograms will ignore any changes after the flag is set, so once the flag is set, it cannot be unset.</p>
</div>
<div class="section" id="count">
<h3><code class="docutils literal"><span class="pre">count</span></code><a class="headerlink" href="#count" title="Permalink to this headline">¶</a></h3>
<p><em>Deprecated</em> (please use uint <a class="reference internal" href="scalars.html"><span class="doc">Scalars</span></a>).</p>
<p>This histogram type is used when you want to record a count of something. It only stores a single value and defaults to <cite>0</cite>.</p>
</div>
<div class="section" id="keyed-histograms">
<span id="histogram-type-keyed"></span><h3>Keyed Histograms<a class="headerlink" href="#keyed-histograms" title="Permalink to this headline">¶</a></h3>
<p>Keyed histograms are collections of one of the histogram types above, indexed by a string key. This is for example useful when you want to break down certain counts by a name, like how often searches happen with which search engine.
Note that when you need to record for a small set of known keys, using separate plain histograms is more efficient.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Keyed histograms are currently not supported in the <a class="reference external" href="https://alerts.telemetry.mozilla.org/index.html">histogram change detector</a>.</p>
</div>
</div>
</div>
<div class="section" id="declaring-a-histogram">
<h2>Declaring a Histogram<a class="headerlink" href="#declaring-a-histogram" title="Permalink to this headline">¶</a></h2>
<p>Histograms should be declared in the <a class="reference external" href="https://dxr.mozilla.org/mozilla-central/source/toolkit/components/telemetry/Histograms.json">Histograms.json</a> file. These declarations are checked for correctness at <a class="reference external" href="https://dxr.mozilla.org/mozilla-central/source/toolkit/components/telemetry/gen_histogram_data.py">compile time</a> and used to generate C++ code.</p>
<p>The following is a sample histogram declaration from <code class="docutils literal"><span class="pre">Histograms.json</span></code> for a histogram named <code class="docutils literal"><span class="pre">MEMORY_RESIDENT</span></code> which tracks the amount of resident memory used by a process:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span>&quot;MEMORY_RESIDENT&quot;: {
  &quot;record_in_processes&quot;: [&quot;main&quot;, &quot;content&quot;],
  &quot;alert_emails&quot;: [&quot;team@mozilla.xyz&quot;],
  &quot;expires_in_version&quot;: &quot;never&quot;,
  &quot;kind&quot;: &quot;exponential&quot;,
  &quot;low&quot;: 32768,
  &quot;high&quot;: 1048576,
  &quot;n_buckets&quot;: 50,
  &quot;bug_numbers&quot;: [12345],
  &quot;description&quot;: &quot;Resident memory size (KB)&quot;
},
</pre></div>
</div>
<p>Histograms which track timings in milliseconds or microseconds should suffix their names with <code class="docutils literal"><span class="pre">&quot;_MS&quot;</span></code> and <code class="docutils literal"><span class="pre">&quot;_US&quot;</span></code> respectively. Flag-type histograms should have the suffix <code class="docutils literal"><span class="pre">&quot;_FLAG&quot;</span></code> in their name.</p>
<p>The possible fields in a histogram declaration are listed below.</p>
<div class="section" id="record-in-processes">
<h3><code class="docutils literal"><span class="pre">record_in_processes</span></code><a class="headerlink" href="#record-in-processes" title="Permalink to this headline">¶</a></h3>
<p>Required. This field is a list of processes this histogram can be recorded in. Currently-supported values are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">main</span></code></li>
<li><code class="docutils literal"><span class="pre">content</span></code></li>
<li><code class="docutils literal"><span class="pre">gpu</span></code></li>
<li><code class="docutils literal"><span class="pre">all_childs</span></code> (record in all child processes)</li>
<li><code class="docutils literal"><span class="pre">all</span></code> (record in all processes)</li>
</ul>
</div>
<div class="section" id="alert-emails">
<h3><code class="docutils literal"><span class="pre">alert_emails</span></code><a class="headerlink" href="#alert-emails" title="Permalink to this headline">¶</a></h3>
<p>Required. This field is a list of e-mail addresses that should be notified when the distribution of the histogram changes significantly from one build-id to the other. This can be useful to detect regressions. Note that all alerts will be sent automatically to mozilla.dev.telemetry-alerts.</p>
</div>
<div class="section" id="expires-in-version">
<h3><code class="docutils literal"><span class="pre">expires_in_version</span></code><a class="headerlink" href="#expires-in-version" title="Permalink to this headline">¶</a></h3>
<p>Required. The version number in which the histogram expires; e.g. a value of <cite>“30”</cite> will mean that the histogram stops recording from Firefox 30 on. A version number of type <code class="docutils literal"><span class="pre">&quot;N&quot;</span></code> and <code class="docutils literal"><span class="pre">&quot;N.0&quot;</span></code> is automatically converted to <code class="docutils literal"><span class="pre">&quot;N.0a1&quot;</span></code> in order to expire the histogram also in the development channels. For histograms that never expire the value <code class="docutils literal"><span class="pre">&quot;never&quot;</span></code> can be used as in the example above. Accumulating data into an expired histogram is effectively a non-op and will not record anything.</p>
</div>
<div class="section" id="kind">
<h3><code class="docutils literal"><span class="pre">kind</span></code><a class="headerlink" href="#kind" title="Permalink to this headline">¶</a></h3>
<p>Required. One of the histogram types described in the previous section. Different histogram types require different fields to be present in the declaration.</p>
</div>
<div class="section" id="keyed">
<h3><code class="docutils literal"><span class="pre">keyed</span></code><a class="headerlink" href="#keyed" title="Permalink to this headline">¶</a></h3>
<p>Optional, boolean, defaults to <code class="docutils literal"><span class="pre">false</span></code>. Determines whether this is a <em>keyed histogram</em>.</p>
</div>
<div class="section" id="keys">
<h3><code class="docutils literal"><span class="pre">keys</span></code><a class="headerlink" href="#keys" title="Permalink to this headline">¶</a></h3>
<p>Optional, list of strings. Only valid for <em>keyed histograms</em>. Defines a case sensitive list of allowed keys that can be used for this histogram. The list is limited to 30 keys with a maximum length of 20 characters. When using a key that is not in the list, the accumulation is discarded and a warning is printed to the browser console.</p>
</div>
<div class="section" id="low">
<h3><code class="docutils literal"><span class="pre">low</span></code><a class="headerlink" href="#low" title="Permalink to this headline">¶</a></h3>
<p>Optional, the default value is <code class="docutils literal"><span class="pre">1</span></code>. This field represents the minimum value expected in the histogram. Note that all histograms automatically get a bucket with label <code class="docutils literal"><span class="pre">0</span></code> for counting values below the <code class="docutils literal"><span class="pre">low</span></code> value. If a histogram does not specify a <code class="docutils literal"><span class="pre">low</span></code> value, it will always have a <code class="docutils literal"><span class="pre">&quot;0&quot;</span></code> bucket (for negative or zero values) and a <code class="docutils literal"><span class="pre">&quot;1&quot;</span></code> bucket (for values between <code class="docutils literal"><span class="pre">1</span></code> and the next bucket).</p>
</div>
<div class="section" id="high">
<h3><code class="docutils literal"><span class="pre">high</span></code><a class="headerlink" href="#high" title="Permalink to this headline">¶</a></h3>
<p>Required for linear and exponential histograms. The maximum value to be stored in a linear or exponential histogram. Any recorded values greater than this maximum will be counted in the last bucket.</p>
</div>
<div class="section" id="n-buckets">
<h3><code class="docutils literal"><span class="pre">n_buckets</span></code><a class="headerlink" href="#n-buckets" title="Permalink to this headline">¶</a></h3>
<p>Required for linear and exponential histograms. The number of buckets in a linear or exponential histogram.</p>
</div>
<div class="section" id="n-values">
<h3><code class="docutils literal"><span class="pre">n_values</span></code><a class="headerlink" href="#n-values" title="Permalink to this headline">¶</a></h3>
<p>Required for enumerated histograms. Similar to n_buckets, it represent the number of elements in the enum.</p>
</div>
<div class="section" id="labels">
<h3><code class="docutils literal"><span class="pre">labels</span></code><a class="headerlink" href="#labels" title="Permalink to this headline">¶</a></h3>
<p>Required for categorical histograms. This is an array of strings which are the labels for different values in this histograms. The labels are restricted to a C++-friendly subset of characters (<code class="docutils literal"><span class="pre">^[a-z][a-z0-9_]+[a-z0-9]$</span></code>). This field is limited to 100 strings, each with a maximum length of 20 characters.</p>
</div>
<div class="section" id="bug-numbers">
<h3><code class="docutils literal"><span class="pre">bug_numbers</span></code><a class="headerlink" href="#bug-numbers" title="Permalink to this headline">¶</a></h3>
<p>Required for all new histograms. This is an array of integers and should at least contain the bug number that added the probe and additionally other bug numbers that affected its behavior.</p>
</div>
<div class="section" id="description">
<h3><code class="docutils literal"><span class="pre">description</span></code><a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h3>
<p>Required. A description of the data tracked by the histogram, e.g. _”Resident memory size”_</p>
</div>
<div class="section" id="cpp-guard">
<h3><code class="docutils literal"><span class="pre">cpp_guard</span></code><a class="headerlink" href="#cpp-guard" title="Permalink to this headline">¶</a></h3>
<p>Optional. This field inserts an #ifdef directive around the histogram’s C++ declaration. This is typically used for platform-specific histograms, e.g. <code class="docutils literal"><span class="pre">&quot;cpp_guard&quot;:</span> <span class="pre">&quot;ANDROID&quot;</span></code></p>
</div>
<div class="section" id="releasechannelcollection">
<h3><code class="docutils literal"><span class="pre">releaseChannelCollection</span></code><a class="headerlink" href="#releasechannelcollection" title="Permalink to this headline">¶</a></h3>
<p>Optional. This is one of:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&quot;opt-in&quot;</span></code>: (default value) This histogram is submitted by default on pre-release channels, unless the user opts out.</li>
<li><code class="docutils literal"><span class="pre">&quot;opt-out&quot;</span></code>: This histogram is submitted by default on release and pre-release channels, unless the user opts out.</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Because they are collected by default, opt-out probes need to meet a higher “user benefit” threshold than opt-in probes during data collection review.</p>
<p class="last"><strong>Every</strong> new data collection in Firefox needs a <a class="reference external" href="https://wiki.mozilla.org/Firefox/Data_Collection#Requesting_Approval">data collection review</a> from a data collection peer. Just set the feedback? flag for one of the data peers.</p>
</div>
</div>
</div>
<div class="section" id="changing-a-histogram">
<h2>Changing a histogram<a class="headerlink" href="#changing-a-histogram" title="Permalink to this headline">¶</a></h2>
<p>Changing histogram declarations after the histogram has been released is tricky. Many tools (like <a class="reference external" href="https://github.com/mozilla/python_mozaggregator">the aggregator</a>) assume histograms don’t change. The current recommended procedure is to change the name of the histogram.</p>
<ul class="simple">
<li>When changing existing histograms, the recommended pattern is to use a versioned name (<code class="docutils literal"><span class="pre">PROBE</span></code>, <code class="docutils literal"><span class="pre">PROBE_2</span></code>, <code class="docutils literal"><span class="pre">PROBE_3</span></code>, …).</li>
<li>For enum histograms, it’s recommended to set “n_buckets” to a slightly larger value than needed since new elements may be added to the enum in the future.</li>
</ul>
<p>The one exception is categorical histograms which can only be changed by adding labels, and only until it reaches 50 labels.</p>
</div>
<div class="section" id="adding-a-javascript-probe">
<h2>Adding a JavaScript Probe<a class="headerlink" href="#adding-a-javascript-probe" title="Permalink to this headline">¶</a></h2>
<p>A Telemetry probe is the code that measures and stores values in a histogram. Probes in privileged JavaScript code can make use of the <a class="reference external" href="https://dxr.mozilla.org/mozilla-central/source/toolkit/components/telemetry/nsITelemetry.idl">nsITelemetry</a> interface to get references to histogram objects. A new value is recorded in the histogram by calling <code class="docutils literal"><span class="pre">add</span></code> on the histogram object:</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">histogram</span> <span class="o">=</span> <span class="nx">Services</span><span class="p">.</span><span class="nx">telemetry</span><span class="p">.</span><span class="nx">getHistogramById</span><span class="p">(</span><span class="s2">&quot;PLACES_AUTOCOMPLETE_1ST_RESULT_TIME_MS&quot;</span><span class="p">);</span>
<span class="nx">histogram</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">measuredDuration</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">keyed</span> <span class="o">=</span> <span class="nx">Services</span><span class="p">.</span><span class="nx">telemetry</span><span class="p">.</span><span class="nx">getKeyedHistogramById</span><span class="p">(</span><span class="s2">&quot;TAG_SEEN_COUNTS&quot;</span><span class="p">);</span>
<span class="nx">keyed</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">&quot;blink&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal"><span class="pre">nsITelemetry.getHistogramById()</span></code> will throw an <code class="docutils literal"><span class="pre">NS_ERROR_FAILURE</span></code> JavaScript exception if it is called with an invalid histogram ID. The <code class="docutils literal"><span class="pre">add()</span></code> function will not throw if it fails, instead it prints an error in the browser console.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Adding a new Telemetry probe is not possible with Artifact builds. A full build is needed.</p>
</div>
<p>For histograms measuring time, <a class="reference external" href="https://dxr.mozilla.org/mozilla-central/source/toolkit/components/telemetry/TelemetryStopwatch.jsm">TelemetryStopwatch</a> can be used to avoid working with Dates manually:</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="nx">TelemetryStopwatch</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s2">&quot;SEARCH_SERVICE_INIT_MS&quot;</span><span class="p">);</span>
<span class="nx">TelemetryStopwatch</span><span class="p">.</span><span class="nx">finish</span><span class="p">(</span><span class="s2">&quot;SEARCH_SERVICE_INIT_MS&quot;</span><span class="p">);</span>

<span class="nx">TelemetryStopwatch</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s2">&quot;FX_TAB_SWITCH_TOTAL_MS&quot;</span><span class="p">);</span>
<span class="nx">TelemetryStopwatch</span><span class="p">.</span><span class="nx">cancel</span><span class="p">(</span><span class="s2">&quot;FX_TAB_SWITCH_TOTAL_MS&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-a-c-probe">
<h2>Adding a C++ Probe<a class="headerlink" href="#adding-a-c-probe" title="Permalink to this headline">¶</a></h2>
<p>Probes in native code can also use the <a class="reference external" href="https://dxr.mozilla.org/mozilla-central/source/toolkit/components/telemetry/nsITelemetry.idl">nsITelemetry</a> interface, but the helper functions declared in <a class="reference external" href="https://dxr.mozilla.org/mozilla-central/source/toolkit/components/telemetry/Telemetry.h">Telemetry.h</a> are more convenient:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;mozilla/Telemetry.h&quot;</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * Adds sample to a histogram defined in Histograms.json</span>
<span class="cm"> *</span>
<span class="cm"> * @param id - histogram id</span>
<span class="cm"> * @param sample - value to record.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">Accumulate</span><span class="p">(</span><span class="n">ID</span> <span class="n">id</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">sample</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Adds sample to a keyed histogram defined in Histograms.h</span>
<span class="cm"> *</span>
<span class="cm"> * @param id - keyed histogram id</span>
<span class="cm"> * @param key - the string key</span>
<span class="cm"> * @param sample - (optional) value to record, defaults to 1.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">Accumulate</span><span class="p">(</span><span class="n">ID</span> <span class="n">id</span><span class="p">,</span> <span class="k">const</span> <span class="n">nsCString</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">sample</span> <span class="o">=</span> <span class="mi">1</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Adds time delta in milliseconds to a histogram defined in Histograms.json</span>
<span class="cm"> *</span>
<span class="cm"> * @param id - histogram id</span>
<span class="cm"> * @param start - start time</span>
<span class="cm"> * @param end - end time</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">AccumulateTimeDelta</span><span class="p">(</span><span class="n">ID</span> <span class="n">id</span><span class="p">,</span> <span class="n">TimeStamp</span> <span class="n">start</span><span class="p">,</span> <span class="n">TimeStamp</span> <span class="n">end</span> <span class="o">=</span> <span class="n">TimeStamp</span><span class="o">::</span><span class="n">Now</span><span class="p">());</span>
</pre></div>
</div>
<p>The histogram names declared in <code class="docutils literal"><span class="pre">Histograms.json</span></code> are translated into constants in the <code class="docutils literal"><span class="pre">mozilla::Telemetry</span></code> namespace:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">mozilla</span><span class="o">::</span><span class="n">Telemetry</span><span class="o">::</span><span class="n">Accumulate</span><span class="p">(</span><span class="n">mozilla</span><span class="o">::</span><span class="n">Telemetry</span><span class="o">::</span><span class="n">STARTUP_CRASH_DETECTED</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Telemetry accumulations are designed to be cheap, not free. If you wish to accumulate values in a performance-sensitive piece of code, store the accumualtions locally and accumulate after the performance-sensitive piece (“hot path”) has completed.</p>
</div>
<p>The <code class="docutils literal"><span class="pre">Telemetry.h</span></code> header also declares the helper classes <code class="docutils literal"><span class="pre">AutoTimer</span></code> and <code class="docutils literal"><span class="pre">AutoCounter</span></code>. Objects of these types automatically record a histogram value when they go out of scope:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">nsresult</span>
<span class="n">nsPluginHost</span><span class="o">::</span><span class="n">StopPluginInstance</span><span class="p">(</span><span class="n">nsNPAPIPluginInstance</span><span class="o">*</span> <span class="n">aInstance</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Telemetry</span><span class="o">::</span><span class="n">AutoTimer</span><span class="o">&lt;</span><span class="n">Telemetry</span><span class="o">::</span><span class="n">PLUGIN_SHUTDOWN_MS</span><span class="o">&gt;</span> <span class="n">timer</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="k">return</span> <span class="n">NS_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="events.html" class="btn btn-neutral float-right" title="Events" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="scalars.html" class="btn btn-neutral" title="Scalars" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright .

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../../',
            VERSION:'59.0a1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>